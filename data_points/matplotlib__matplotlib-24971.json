{
  "repo": "matplotlib/matplotlib",
  "instance_id": "matplotlib__matplotlib-24971",
  "base_commit": "a3011dfd1aaa2487cce8aa7369475533133ef777",
  "patch": "diff --git a/lib/matplotlib/_tight_bbox.py b/lib/matplotlib/_tight_bbox.py\n--- a/lib/matplotlib/_tight_bbox.py\n+++ b/lib/matplotlib/_tight_bbox.py\n@@ -17,8 +17,6 @@ def adjust_bbox(fig, bbox_inches, fixed_dpi=None):\n     \"\"\"\n     origBbox = fig.bbox\n     origBboxInches = fig.bbox_inches\n-    orig_layout = fig.get_layout_engine()\n-    fig.set_layout_engine(None)\n     _boxout = fig.transFigure._boxout\n \n     old_aspect = []\n@@ -46,7 +44,6 @@ def restore_bbox():\n \n         fig.bbox = origBbox\n         fig.bbox_inches = origBboxInches\n-        fig.set_layout_engine(orig_layout)\n         fig.transFigure._boxout = _boxout\n         fig.transFigure.invalidate()\n         fig.patch.set_bounds(0, 0, 1, 1)\n",
  "test_patch": "diff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -532,6 +532,13 @@ def test_savefig_pixel_ratio(backend):\n     assert ratio1 == ratio2\n \n \n+def test_savefig_preserve_layout_engine(tmp_path):\n+    fig = plt.figure(layout='compressed')\n+    fig.savefig(tmp_path / 'foo.png', bbox_inches='tight')\n+\n+    assert fig.get_layout_engine()._compress\n+\n+\n def test_figure_repr():\n     fig = plt.figure(figsize=(10, 20), dpi=10)\n     assert repr(fig) == \"<Figure size 100x200 with 0 Axes>\"\n",
  "problem_statement": "[Bug]: compressed layout setting can be forgotten on second save\n### Bug summary\r\n\r\nI'm not sure whether this is really a bug or I'm just using an inconsistent combination of options.  Under some specific circumstances (see below) compressed layout is not applied the second time a figure is saved.\r\n\r\n### Code for reproduction\r\n\r\n```python\r\nimport matplotlib\r\nimport matplotlib.pyplot as plt\r\nimport numpy as np\r\n\r\narr = np.arange(100).reshape((10, 10))\r\n\r\nmatplotlib.rcParams['figure.constrained_layout.use'] = True\r\n\r\nfig, ax_dict = plt.subplot_mosaic('AB;AC', figsize=(6, 9), width_ratios=[3, 2],\r\n                                  layout='compressed')\r\n\r\nfor key in [\"B\", \"C\"]:\r\n    ax_dict[key].imshow(arr)\r\n    \r\nfig.savefig(\"test1.png\", bbox_inches=\"tight\")\r\nfig.savefig(\"test2.png\", bbox_inches=\"tight\")\r\n```\r\n\r\n\r\n### Actual outcome\r\n\r\ntest1.png\r\n![test1](https://user-images.githubusercontent.com/10599679/212073531-4841d847-29a5-45a4-aaa1-1d3b81277ddc.png)\r\n\r\ntest2.png\r\n![test2](https://user-images.githubusercontent.com/10599679/212073574-f6286243-690d-4199-b6f4-4033e5d14635.png)\r\n\r\n\r\n### Expected outcome\r\n\r\nBoth images should look like the first.\r\n\r\n### Additional information\r\n\r\nIf I do not set the `rcParams`, all is well.  If I do not set `bbox_inches=\"tight\"` in my calls to `savefig`, the images are identical (but I have too much white space top and bottom).  Maybe there is a better option than `bbox_inches=\"tight\"` when using compressed layout?\r\n\r\nFor context, my real example is a script that makes several figures.  For most of them I want constrained layout, so I set that once in the `rcParams` for convenience.  Only one figure needs \"compressed\", and I am saving twice because I want both a png and a pdf.  Fixed it in my current example by just reverting the `rcParams` setting for the one figure.\r\n\r\n### Operating system\r\n\r\nRHEL7\r\n\r\n### Matplotlib Version\r\n\r\n3.6.2 and main\r\n\r\n### Matplotlib Backend\r\n\r\nQtAgg\r\n\r\n### Python version\r\n\r\n3.9 and 3.11\r\n\r\n### Jupyter version\r\n\r\n_No response_\r\n\r\n### Installation\r\n\r\nconda\n",
  "hints_text": "Yeah we do some dancing around when we save with bbox inches - so this seems to get caught in that. I tried to track it down, but the figure-saving stack is full of context managers, and I can't see where the layout manager gets reset.  Hopefully someone more cognizant of that part of the codebase can explain.  \r\n\nThanks for looking @jklymak ðŸ™‚\nI think it is set (temporarily) here;\r\nhttps://github.com/matplotlib/matplotlib/blob/018c5efbbec68f27cfea66ca2620702dd976d1b9/lib/matplotlib/backend_bases.py#L2356-L2357\nIt is, but I don't understand what `_cm_set` does to reset the layout engine after this.  Somehow it is dropping the old layout engine and making a new one, and the new one doesn't know that the old one was a 'compressed' engine.  \nIt calls `get_{kwarg}` and after running calls `set({kwarg}={old value})`. So here it calls `oldvalue = figure.get_layout_engine()` and `figure.set(layout_engine=oldvalue)`. Is `figure.set_layout_engine(figure.get_layout_engine())` working correctly?\nI am way out of my depth here but\r\n\r\n```python\r\nimport matplotlib.pyplot as plt\r\n\r\nplt.rcParams['figure.constrained_layout.use'] = True\r\nfig = plt.figure(layout=\"compressed\")\r\n\r\nprint(fig.get_layout_engine()._compress)\r\nfig.set_layout_engine(fig.get_layout_engine())\r\nprint(fig.get_layout_engine()._compress)\r\n\r\nfig.savefig('foo.png', bbox_inches='tight')\r\nprint(fig.get_layout_engine()._compress)\r\n```\r\n\r\n```\r\nTrue\r\nTrue\r\nFalse\r\n```\r\n\r\nWithout the `rcParams` line, `fig.get_layout_engine()` returns `None` after the `savefig`.\nI _think_ the problem is the call to `adjust_bbox`\r\nhttps://github.com/matplotlib/matplotlib/blob/018c5efbbec68f27cfea66ca2620702dd976d1b9/lib/matplotlib/backend_bases.py#L2349-L2350\r\n\r\nwhich explicity calls\r\nhttps://github.com/matplotlib/matplotlib/blob/a3011dfd1aaa2487cce8aa7369475533133ef777/lib/matplotlib/_tight_bbox.py#L21\r\n\r\nwhich will use the default constrained layout engine if the `rcParams` is set\r\nhttps://github.com/matplotlib/matplotlib/blob/a3011dfd1aaa2487cce8aa7369475533133ef777/lib/matplotlib/figure.py#L2599-L2610",
  "created_at": "2023-01-13T14:32:35Z",
  "version": "3.6",
  "FAIL_TO_PASS": "[\"lib/matplotlib/tests/test_figure.py::test_savefig_preserve_layout_engine\"]",
  "PASS_TO_PASS": "[\"lib/matplotlib/tests/test_figure.py::test_align_labels[png]\", \"lib/matplotlib/tests/test_figure.py::test_align_labels_stray_axes\", \"lib/matplotlib/tests/test_figure.py::test_figure_label\", \"lib/matplotlib/tests/test_figure.py::test_fignum_exists\", \"lib/matplotlib/tests/test_figure.py::test_clf_keyword\", \"lib/matplotlib/tests/test_figure.py::test_figure[png]\", \"lib/matplotlib/tests/test_figure.py::test_figure[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_figure_legend[png]\", \"lib/matplotlib/tests/test_figure.py::test_figure_legend[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_gca\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_subclass\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_invalid\", \"lib/matplotlib/tests/test_figure.py::test_suptitle[png]\", \"lib/matplotlib/tests/test_figure.py::test_suptitle[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_suptitle_fontproperties\", \"lib/matplotlib/tests/test_figure.py::test_alpha[png]\", \"lib/matplotlib/tests/test_figure.py::test_too_many_figures\", \"lib/matplotlib/tests/test_figure.py::test_iterability_axes_argument\", \"lib/matplotlib/tests/test_figure.py::test_set_fig_size\", \"lib/matplotlib/tests/test_figure.py::test_axes_remove\", \"lib/matplotlib/tests/test_figure.py::test_figaspect\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[both]\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[major]\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[minor]\", \"lib/matplotlib/tests/test_figure.py::test_change_dpi\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[1-nan]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[-1-1]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[inf-1]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_add_axes\", \"lib/matplotlib/tests/test_figure.py::test_subplots_shareax_loglabels\", \"lib/matplotlib/tests/test_figure.py::test_savefig\", \"lib/matplotlib/tests/test_figure.py::test_savefig_warns\", \"lib/matplotlib/tests/test_figure.py::test_savefig_backend\", \"lib/matplotlib/tests/test_figure.py::test_savefig_pixel_ratio[Agg]\", \"lib/matplotlib/tests/test_figure.py::test_savefig_pixel_ratio[Cairo]\", \"lib/matplotlib/tests/test_figure.py::test_figure_repr\", \"lib/matplotlib/tests/test_figure.py::test_valid_layouts\", \"lib/matplotlib/tests/test_figure.py::test_invalid_layouts\", \"lib/matplotlib/tests/test_figure.py::test_layout_change_warning[constrained]\", \"lib/matplotlib/tests/test_figure.py::test_layout_change_warning[compressed]\", \"lib/matplotlib/tests/test_figure.py::test_add_artist[png]\", \"lib/matplotlib/tests/test_figure.py::test_add_artist[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[png]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[ps]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[eps]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[svg]\", \"lib/matplotlib/tests/test_figure.py::test_tightbbox\", \"lib/matplotlib/tests/test_figure.py::test_axes_removal\", \"lib/matplotlib/tests/test_figure.py::test_removed_axis\", \"lib/matplotlib/tests/test_figure.py::test_figure_clear[clear]\", \"lib/matplotlib/tests/test_figure.py::test_figure_clear[clf]\", \"lib/matplotlib/tests/test_figure.py::test_clf_not_redefined\", \"lib/matplotlib/tests/test_figure.py::test_picking_does_not_stale\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_twotuple\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[eps]\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x1-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x2-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x3-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_all_nested[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_tuple[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_width_ratios\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_height_ratios\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x0-None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x1-SKIP-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x2-0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x3-None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x4-SKIP-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x5-0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail_list_of_str\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[subplot_kw0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[subplot_kw1-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_per_subplot_kw[BC-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_per_subplot_kw[multi_value1-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_string_parser\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_per_subplot_kw_expander\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_extra_per_subplot_kw\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[AAA\\\\nBBB-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[\\\\nAAA\\\\nBBB\\\\n-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[ABC\\\\nDEF-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x0-(?m)we\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x1-There\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[AAA\\\\nc\\\\nBBB-All\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x3-All\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_hashable_keys[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[abc]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[cab]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[bca]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[cba]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[acb]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[bac]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_user_order\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_share_all\", \"lib/matplotlib/tests/test_figure.py::test_reused_gridspec\", \"lib/matplotlib/tests/test_figure.py::test_subfigure[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_tightbbox\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_dpi\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_ss[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_double[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_spanning\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_ticks\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_scatter_size[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_pdf\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_kwargs\", \"lib/matplotlib/tests/test_figure.py::test_add_axes_kwargs\", \"lib/matplotlib/tests/test_figure.py::test_ginput\", \"lib/matplotlib/tests/test_figure.py::test_waitforbuttonpress\", \"lib/matplotlib/tests/test_figure.py::test_kwargs_pass\", \"lib/matplotlib/tests/test_figure.py::test_rcparams[png]\", \"lib/matplotlib/tests/test_figure.py::test_deepcopy\", \"lib/matplotlib/tests/test_figure.py::test_unpickle_with_device_pixel_ratio\", \"lib/matplotlib/tests/test_figure.py::test_gridspec_no_mutate_input\"]",
  "environment_setup_commit": "73909bcb408886a22e2b84581d6b9e6d9907c813",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.816008",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}