{
  "repo": "sphinx-doc/sphinx",
  "instance_id": "sphinx-doc__sphinx-10191",
  "base_commit": "301c7bdf57eee47426c9ad4d96392bff623ee6c3",
  "patch": "diff --git a/sphinx/writers/latex.py b/sphinx/writers/latex.py\n--- a/sphinx/writers/latex.py\n+++ b/sphinx/writers/latex.py\n@@ -814,16 +814,14 @@ def depart_rubric(self, node: Element) -> None:\n     def visit_footnote(self, node: Element) -> None:\n         self.in_footnote += 1\n         label = cast(nodes.label, node[0])\n-        if 'referred' in node:\n-            self.body.append(r'\\sphinxstepexplicit ')\n         if self.in_parsed_literal:\n             self.body.append(r'\\begin{footnote}[%s]' % label.astext())\n         else:\n             self.body.append('%' + CR)\n             self.body.append(r'\\begin{footnote}[%s]' % label.astext())\n         if 'referred' in node:\n-            self.body.append(r'\\phantomsection'\n-                             r'\\label{\\thesphinxscope.%s}%%' % label.astext() + CR)\n+            # TODO: in future maybe output a latex macro with backrefs here\n+            pass\n         self.body.append(r'\\sphinxAtStartFootnote' + CR)\n \n     def depart_footnote(self, node: Element) -> None:\n@@ -1717,9 +1715,7 @@ def depart_footnotemark(self, node: Element) -> None:\n     def visit_footnotetext(self, node: Element) -> None:\n         label = cast(nodes.label, node[0])\n         self.body.append('%' + CR)\n-        self.body.append(r'\\begin{footnotetext}[%s]'\n-                         r'\\phantomsection\\label{\\thesphinxscope.%s}%%'\n-                         % (label.astext(), label.astext()) + CR)\n+        self.body.append(r'\\begin{footnotetext}[%s]' % label.astext())\n         self.body.append(r'\\sphinxAtStartFootnote' + CR)\n \n     def depart_footnotetext(self, node: Element) -> None:\n",
  "test_patch": "diff --git a/tests/test_build_latex.py b/tests/test_build_latex.py\n--- a/tests/test_build_latex.py\n+++ b/tests/test_build_latex.py\n@@ -723,13 +723,9 @@ def test_footnote(app, status, warning):\n     assert '\\\\sphinxcite{footnote:bar}' in result\n     assert ('\\\\bibitem[bar]{footnote:bar}\\n\\\\sphinxAtStartPar\\ncite\\n') in result\n     assert '\\\\sphinxcaption{Table caption \\\\sphinxfootnotemark[4]' in result\n-    assert ('\\\\hline%\\n\\\\begin{footnotetext}[4]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.4}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+    assert ('\\\\hline%\\n\\\\begin{footnotetext}[4]\\\\sphinxAtStartFootnote\\n'\n             'footnote in table caption\\n%\\n\\\\end{footnotetext}\\\\ignorespaces %\\n'\n-            '\\\\begin{footnotetext}[5]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.5}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[5]\\\\sphinxAtStartFootnote\\n'\n             'footnote in table header\\n%\\n\\\\end{footnotetext}\\\\ignorespaces '\n             '\\n\\\\sphinxAtStartPar\\n'\n             'VIDIOC\\\\_CROPCAP\\n&\\n\\\\sphinxAtStartPar\\n') in result\n@@ -755,27 +751,19 @@ def test_reference_in_caption_and_codeblock_in_footnote(app, status, warning):\n     assert '\\\\subsubsection*{The rubric title with a reference to {[}AuthorYear{]}}' in result\n     assert ('\\\\chapter{The section with a reference to \\\\sphinxfootnotemark[6]}\\n'\n             '\\\\label{\\\\detokenize{index:the-section-with-a-reference-to}}'\n-            '%\\n\\\\begin{footnotetext}[6]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.6}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '%\\n\\\\begin{footnotetext}[6]\\\\sphinxAtStartFootnote\\n'\n             'Footnote in section\\n%\\n\\\\end{footnotetext}') in result\n     assert ('\\\\caption{This is the figure caption with a footnote to '\n             '\\\\sphinxfootnotemark[8].}\\\\label{\\\\detokenize{index:id35}}\\\\end{figure}\\n'\n-            '%\\n\\\\begin{footnotetext}[8]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.8}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '%\\n\\\\begin{footnotetext}[8]\\\\sphinxAtStartFootnote\\n'\n             'Footnote in caption\\n%\\n\\\\end{footnotetext}') in result\n     assert ('\\\\sphinxcaption{footnote \\\\sphinxfootnotemark[9] in '\n             'caption of normal table}\\\\label{\\\\detokenize{index:id36}}') in result\n     assert ('\\\\caption{footnote \\\\sphinxfootnotemark[10] '\n             'in caption \\\\sphinxfootnotemark[11] of longtable\\\\strut}') in result\n-    assert ('\\\\endlastfoot\\n%\\n\\\\begin{footnotetext}[10]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.10}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+    assert ('\\\\endlastfoot\\n%\\n\\\\begin{footnotetext}[10]\\\\sphinxAtStartFootnote\\n'\n             'Foot note in longtable\\n%\\n\\\\end{footnotetext}\\\\ignorespaces %\\n'\n-            '\\\\begin{footnotetext}[11]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.11}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[11]\\\\sphinxAtStartFootnote\\n'\n             'Second footnote in caption of longtable\\n') in result\n     assert ('This is a reference to the code\\\\sphinxhyphen{}block in the footnote:\\n'\n             '{\\\\hyperref[\\\\detokenize{index:codeblockinfootnote}]'\n@@ -795,13 +783,13 @@ def test_footnote_referred_multiple_times(app, status, warning):\n     print(status.getvalue())\n     print(warning.getvalue())\n \n-    assert ('Explicitly numbered footnote: \\\\sphinxstepexplicit %\\n'\n-            '\\\\begin{footnote}[100]\\\\phantomsection\\\\label{\\\\thesphinxscope.100}%\\n'\n+    assert ('Explicitly numbered footnote: %\\n'\n+            '\\\\begin{footnote}[100]'\n             '\\\\sphinxAtStartFootnote\\nNumbered footnote\\n%\\n'\n             '\\\\end{footnote} \\\\sphinxfootnotemark[100]\\n'\n             in result)\n-    assert ('Named footnote: \\\\sphinxstepexplicit %\\n'\n-            '\\\\begin{footnote}[13]\\\\phantomsection\\\\label{\\\\thesphinxscope.13}%\\n'\n+    assert ('Named footnote: %\\n'\n+            '\\\\begin{footnote}[13]'\n             '\\\\sphinxAtStartFootnote\\nNamed footnote\\n%\\n'\n             '\\\\end{footnote} \\\\sphinxfootnotemark[13]\\n'\n             in result)\n@@ -837,9 +825,7 @@ def test_latex_show_urls_is_inline(app, status, warning):\n     assert '\\\\sphinxhref{http://sphinx-doc.org/}{Sphinx} (http://sphinx\\\\sphinxhyphen{}doc.org/)' in result\n     assert ('Third footnote: %\\n\\\\begin{footnote}[3]\\\\sphinxAtStartFootnote\\n'\n             'Third \\\\sphinxfootnotemark[4]\\n%\\n\\\\end{footnote}%\\n'\n-            '\\\\begin{footnotetext}[4]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.4}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[4]\\\\sphinxAtStartFootnote\\n'\n             'Footnote inside footnote\\n%\\n\\\\end{footnotetext}\\\\ignorespaces') in result\n     assert ('Fourth footnote: %\\n\\\\begin{footnote}[5]\\\\sphinxAtStartFootnote\\n'\n             'Fourth\\n%\\n\\\\end{footnote}\\n') in result\n@@ -849,8 +835,12 @@ def test_latex_show_urls_is_inline(app, status, warning):\n             '(http://sphinx\\\\sphinxhyphen{}doc.org/)}\\n'\n             '\\\\sphinxAtStartPar\\nDescription' in result)\n     assert ('\\\\sphinxlineitem{Footnote in term \\\\sphinxfootnotemark[7]}%\\n'\n-            '\\\\begin{footnotetext}[7]\\\\phantomsection\\\\label{\\\\thesphinxscope.7}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[7]\\\\sphinxAtStartFootnote\\n')\n+    assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}{URL in term} '\n+            '(http://sphinx\\\\sphinxhyphen{}doc.org/)}\\n'\n+            '\\\\sphinxAtStartPar\\nDescription' in result)\n+    assert ('\\\\sphinxlineitem{Footnote in term \\\\sphinxfootnotemark[7]}%\\n'\n+            '\\\\begin{footnotetext}[7]\\\\sphinxAtStartFootnote\\n'\n             'Footnote in term\\n%\\n\\\\end{footnotetext}\\\\ignorespaces '\n             '\\n\\\\sphinxAtStartPar\\nDescription') in result\n     assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}{Term in deflist} '\n@@ -893,9 +883,7 @@ def test_latex_show_urls_is_footnote(app, status, warning):\n             '\\\\sphinxnolinkurl{http://sphinx-doc.org/}\\n%\\n\\\\end{footnote}') in result\n     assert ('Third footnote: %\\n\\\\begin{footnote}[6]\\\\sphinxAtStartFootnote\\n'\n             'Third \\\\sphinxfootnotemark[7]\\n%\\n\\\\end{footnote}%\\n'\n-            '\\\\begin{footnotetext}[7]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.7}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[7]\\\\sphinxAtStartFootnote\\n'\n             'Footnote inside footnote\\n%\\n'\n             '\\\\end{footnotetext}\\\\ignorespaces') in result\n     assert ('Fourth footnote: %\\n\\\\begin{footnote}[8]\\\\sphinxAtStartFootnote\\n'\n@@ -905,18 +893,18 @@ def test_latex_show_urls_is_footnote(app, status, warning):\n             '\\\\sphinxnolinkurl{http://sphinx-doc.org/~test/}\\n%\\n\\\\end{footnote}') in result\n     assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}'\n             '{URL in term}\\\\sphinxfootnotemark[10]}%\\n'\n-            '\\\\begin{footnotetext}[10]\\\\phantomsection\\\\label{\\\\thesphinxscope.10}%\\n'\n+            '\\\\begin{footnotetext}[10]'\n             '\\\\sphinxAtStartFootnote\\n'\n             '\\\\sphinxnolinkurl{http://sphinx-doc.org/}\\n%\\n'\n             '\\\\end{footnotetext}\\\\ignorespaces \\n\\\\sphinxAtStartPar\\nDescription') in result\n     assert ('\\\\sphinxlineitem{Footnote in term \\\\sphinxfootnotemark[12]}%\\n'\n-            '\\\\begin{footnotetext}[12]\\\\phantomsection\\\\label{\\\\thesphinxscope.12}%\\n'\n+            '\\\\begin{footnotetext}[12]'\n             '\\\\sphinxAtStartFootnote\\n'\n             'Footnote in term\\n%\\n\\\\end{footnotetext}\\\\ignorespaces '\n             '\\n\\\\sphinxAtStartPar\\nDescription') in result\n     assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}{Term in deflist}'\n             '\\\\sphinxfootnotemark[11]}%\\n'\n-            '\\\\begin{footnotetext}[11]\\\\phantomsection\\\\label{\\\\thesphinxscope.11}%\\n'\n+            '\\\\begin{footnotetext}[11]'\n             '\\\\sphinxAtStartFootnote\\n'\n             '\\\\sphinxnolinkurl{http://sphinx-doc.org/}\\n%\\n'\n             '\\\\end{footnotetext}\\\\ignorespaces \\n\\\\sphinxAtStartPar\\nDescription') in result\n@@ -955,9 +943,7 @@ def test_latex_show_urls_is_no(app, status, warning):\n     assert '\\\\sphinxhref{http://sphinx-doc.org/}{Sphinx}' in result\n     assert ('Third footnote: %\\n\\\\begin{footnote}[3]\\\\sphinxAtStartFootnote\\n'\n             'Third \\\\sphinxfootnotemark[4]\\n%\\n\\\\end{footnote}%\\n'\n-            '\\\\begin{footnotetext}[4]'\n-            '\\\\phantomsection\\\\label{\\\\thesphinxscope.4}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[4]\\\\sphinxAtStartFootnote\\n'\n             'Footnote inside footnote\\n%\\n\\\\end{footnotetext}\\\\ignorespaces') in result\n     assert ('Fourth footnote: %\\n\\\\begin{footnote}[5]\\\\sphinxAtStartFootnote\\n'\n             'Fourth\\n%\\n\\\\end{footnote}\\n') in result\n@@ -965,8 +951,7 @@ def test_latex_show_urls_is_no(app, status, warning):\n     assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}{URL in term}}\\n'\n             '\\\\sphinxAtStartPar\\nDescription') in result\n     assert ('\\\\sphinxlineitem{Footnote in term \\\\sphinxfootnotemark[7]}%\\n'\n-            '\\\\begin{footnotetext}[7]\\\\phantomsection\\\\label{\\\\thesphinxscope.7}%\\n'\n-            '\\\\sphinxAtStartFootnote\\n'\n+            '\\\\begin{footnotetext}[7]\\\\sphinxAtStartFootnote\\n'\n             'Footnote in term\\n%\\n\\\\end{footnotetext}\\\\ignorespaces '\n             '\\n\\\\sphinxAtStartPar\\nDescription') in result\n     assert ('\\\\sphinxlineitem{\\\\sphinxhref{http://sphinx-doc.org/}{Term in deflist}}'\n",
  "problem_statement": "Alternating multiply referred footnotes produce a ? in pdf output\n### Describe the bug\r\n\r\nIn some circumstances footnote mark is rendered as `?` and there is no hyperlink\r\n\r\n### How to Reproduce\r\n\r\nfile `index.rst`: \r\n\r\n```\r\nTest\r\n====\r\n\r\nExplicitly numbered footnotes\r\n-----------------------------\r\n\r\nFirst reference to first footnote [1]_ \r\n\r\nFirst reference to second footnote [2]_\r\n\r\nSecond reference to first footnote [1]_\r\n\r\nSecond reference to second footnote [2]_\r\n\r\n\r\n.. rubric:: Footnotes\r\n\r\n.. [1] A first footnote\r\n\r\n.. [2] A second footnote\r\n```\r\n\r\nthen `make latexpdf`.\r\n\r\n### Expected behavior\r\n\r\nFootnotes are rendered correctly\r\n\r\n### Your project\r\n\r\nSee above code\r\n\r\n### Screenshots\r\n\r\n![Capture d’écran 2022-02-13 à 09 32 11](https://user-images.githubusercontent.com/2589111/153745645-840efe61-7bdc-4855-99bc-1862f415932a.png)\r\n\r\n\r\n### OS\r\n\r\nMac\r\n\r\n### Python version\r\n\r\n3.8.7 (CPython)\r\n\r\n### Sphinx version\r\n\r\n4.4.0 and current 4.x (v4.5.0+/4ba056870)\r\n\r\n### Sphinx extensions\r\n\r\n_No response_\r\n\r\n### Extra tools\r\n\r\n_No response_\r\n\r\n### Additional context\r\n\r\n_No response_\n",
  "hints_text": "The #8832 mechanism fixed some problems with explicitly numbered footnotes (and #10169 extended this to named footnotes). But this mechanism is flawed when new named or explicitly numbered footnotes occur in-between multiple references to same original one.",
  "created_at": "2022-02-13T20:19:28Z",
  "version": "5.0",
  "FAIL_TO_PASS": "[\"tests/test_build_latex.py::test_footnote\", \"tests/test_build_latex.py::test_reference_in_caption_and_codeblock_in_footnote\", \"tests/test_build_latex.py::test_footnote_referred_multiple_times\", \"tests/test_build_latex.py::test_latex_show_urls_is_inline\", \"tests/test_build_latex.py::test_latex_show_urls_is_footnote\", \"tests/test_build_latex.py::test_latex_show_urls_is_no\", \"tests/test_build_latex.py::test_latex_show_urls_footnote_and_substitutions\"]",
  "PASS_TO_PASS": "[\"tests/test_build_latex.py::test_writer\", \"tests/test_build_latex.py::test_latex_warnings\", \"tests/test_build_latex.py::test_latex_basic\", \"tests/test_build_latex.py::test_latex_basic_manual\", \"tests/test_build_latex.py::test_latex_basic_howto\", \"tests/test_build_latex.py::test_latex_basic_manual_ja\", \"tests/test_build_latex.py::test_latex_basic_howto_ja\", \"tests/test_build_latex.py::test_latex_theme\", \"tests/test_build_latex.py::test_latex_theme_papersize\", \"tests/test_build_latex.py::test_latex_theme_options\", \"tests/test_build_latex.py::test_latex_additional_settings_for_language_code\", \"tests/test_build_latex.py::test_latex_additional_settings_for_greek\", \"tests/test_build_latex.py::test_latex_title_after_admonitions\", \"tests/test_build_latex.py::test_latex_release\", \"tests/test_build_latex.py::test_numref\", \"tests/test_build_latex.py::test_numref_with_prefix1\", \"tests/test_build_latex.py::test_numref_with_prefix2\", \"tests/test_build_latex.py::test_numref_with_language_ja\", \"tests/test_build_latex.py::test_latex_obey_numfig_is_false\", \"tests/test_build_latex.py::test_latex_obey_numfig_secnum_depth_is_zero\", \"tests/test_build_latex.py::test_latex_obey_numfig_secnum_depth_is_two\", \"tests/test_build_latex.py::test_latex_obey_numfig_but_math_numfig_false\", \"tests/test_build_latex.py::test_latex_add_latex_package\", \"tests/test_build_latex.py::test_babel_with_no_language_settings\", \"tests/test_build_latex.py::test_babel_with_language_de\", \"tests/test_build_latex.py::test_babel_with_language_ru\", \"tests/test_build_latex.py::test_babel_with_language_tr\", \"tests/test_build_latex.py::test_babel_with_language_ja\", \"tests/test_build_latex.py::test_babel_with_unknown_language\", \"tests/test_build_latex.py::test_polyglossia_with_language_de\", \"tests/test_build_latex.py::test_polyglossia_with_language_de_1901\", \"tests/test_build_latex.py::test_image_in_section\", \"tests/test_build_latex.py::test_latex_logo_if_not_found\", \"tests/test_build_latex.py::test_toctree_maxdepth_manual\", \"tests/test_build_latex.py::test_toctree_maxdepth_howto\", \"tests/test_build_latex.py::test_toctree_not_found\", \"tests/test_build_latex.py::test_toctree_without_maxdepth\", \"tests/test_build_latex.py::test_toctree_with_deeper_maxdepth\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_None\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_part\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_part_with_howto\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_chapter\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_chapter_with_howto\", \"tests/test_build_latex.py::test_latex_toplevel_sectioning_is_section\", \"tests/test_build_latex.py::test_latex_table_tabulars\", \"tests/test_build_latex.py::test_latex_table_longtable\", \"tests/test_build_latex.py::test_latex_table_complex_tables\", \"tests/test_build_latex.py::test_latex_table_custom_template_caseA\", \"tests/test_build_latex.py::test_latex_table_custom_template_caseB\", \"tests/test_build_latex.py::test_latex_table_custom_template_caseC\", \"tests/test_build_latex.py::test_latex_raw_directive\", \"tests/test_build_latex.py::test_latex_images\", \"tests/test_build_latex.py::test_latex_index\", \"tests/test_build_latex.py::test_latex_equations\", \"tests/test_build_latex.py::test_latex_image_in_parsed_literal\", \"tests/test_build_latex.py::test_latex_nested_enumerated_list\", \"tests/test_build_latex.py::test_latex_thebibliography\", \"tests/test_build_latex.py::test_latex_glossary\", \"tests/test_build_latex.py::test_latex_labels\", \"tests/test_build_latex.py::test_latex_figure_in_admonition\", \"tests/test_build_latex.py::test_default_latex_documents\", \"tests/test_build_latex.py::test_index_on_title\", \"tests/test_build_latex.py::test_texescape_for_non_unicode_supported_engine\", \"tests/test_build_latex.py::test_texescape_for_unicode_supported_engine\", \"tests/test_build_latex.py::test_latex_elements_extrapackages\", \"tests/test_build_latex.py::test_latex_nested_tables\", \"tests/test_build_latex.py::test_latex_container\"]",
  "environment_setup_commit": "60775ec4c4ea08509eee4b564cbf90f316021aff",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:31.030963",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}