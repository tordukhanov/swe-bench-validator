{
  "repo": "pydata/xarray",
  "instance_id": "pydata__xarray-6386",
  "base_commit": "073512ed3f997c0589af97eaf3d4b20796b18cf8",
  "patch": "diff --git a/xarray/core/groupby.py b/xarray/core/groupby.py\n--- a/xarray/core/groupby.py\n+++ b/xarray/core/groupby.py\n@@ -996,7 +996,7 @@ def _combine(self, applied):\n         if coord is not None and dim not in applied_example.dims:\n             index, index_vars = create_default_index_implicit(coord)\n             indexes = {k: index for k in index_vars}\n-            combined = combined._overwrite_indexes(indexes, variables=index_vars)\n+            combined = combined._overwrite_indexes(indexes, index_vars)\n         combined = self._maybe_restore_empty_groups(combined)\n         combined = self._maybe_unstack(combined)\n         return combined\n",
  "test_patch": "diff --git a/xarray/tests/test_groupby.py b/xarray/tests/test_groupby.py\n--- a/xarray/tests/test_groupby.py\n+++ b/xarray/tests/test_groupby.py\n@@ -934,6 +934,14 @@ def test_groupby_dataset_assign():\n     assert_identical(actual, expected)\n \n \n+def test_groupby_dataset_map_dataarray_func():\n+    # regression GH6379\n+    ds = xr.Dataset({\"foo\": (\"x\", [1, 2, 3, 4])}, coords={\"x\": [0, 0, 1, 1]})\n+    actual = ds.groupby(\"x\").map(lambda grp: grp.foo.mean())\n+    expected = xr.DataArray([1.5, 3.5], coords={\"x\": [0, 1]}, dims=\"x\", name=\"foo\")\n+    assert_identical(actual, expected)\n+\n+\n class TestDataArrayGroupBy:\n     @pytest.fixture(autouse=True)\n     def setup(self):\n",
  "problem_statement": "Dataset groupby returning DataArray broken in some cases\n### What happened?\r\n\r\nGot a TypeError when resampling a dataset along a dimension, mapping a function to each group. The function returns a DataArray.\r\n\r\nFailed with : `TypeError: _overwrite_indexes() got an unexpected keyword argument 'variables' `\r\n\r\n### What did you expect to happen?\r\n\r\nThis worked before the merging of #5692. A DataArray was returned as expected.\r\n\r\n### Minimal Complete Verifiable Example\r\n\r\n```Python\r\nimport xarray as xr\r\n\r\nds = xr.tutorial.open_dataset(\"air_temperature\")\r\n\r\nds.resample(time=\"YS\").map(lambda grp: grp.air.mean(\"time\"))\r\n```\r\n\r\n\r\n### Relevant log output\r\n\r\n```Python\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\nInput In [37], in <module>\r\n----> 1 ds.resample(time=\"YS\").map(lambda grp: grp.air.mean(\"time\"))\r\n\r\nFile /opt/miniconda3/envs/xclim-pip/lib/python3.9/site-packages/xarray/core/resample.py:300, in DatasetResample.map(self, func, args, shortcut, **kwargs)\r\n    298 # ignore shortcut if set (for now)\r\n    299 applied = (func(ds, *args, **kwargs) for ds in self._iter_grouped())\r\n--> 300 combined = self._combine(applied)\r\n    302 return combined.rename({self._resample_dim: self._dim})\r\n\r\nFile /opt/miniconda3/envs/xclim-pip/lib/python3.9/site-packages/xarray/core/groupby.py:999, in DatasetGroupByBase._combine(self, applied)\r\n    997     index, index_vars = create_default_index_implicit(coord)\r\n    998     indexes = {k: index for k in index_vars}\r\n--> 999     combined = combined._overwrite_indexes(indexes, variables=index_vars)\r\n   1000 combined = self._maybe_restore_empty_groups(combined)\r\n   1001 combined = self._maybe_unstack(combined)\r\n\r\nTypeError: _overwrite_indexes() got an unexpected keyword argument 'variables'\r\n```\r\n\r\n### Anything else we need to know?\r\n\r\nIn the docstring of `DatasetGroupBy.map` it is not made clear that the passed function should return a dataset, but the opposite is also not said. This worked before and I think the issues comes from #5692, which introduced different signatures for `DataArray._overwrite_indexes` (which is called in my case) and `Dataset._overwrite_indexes` (which is expected by the new `_combine`).\r\n\r\nIf the function passed to `Dataset.resample(...).map` should only return `Dataset`s then I believe a more explicit error is needed, as well as some notice in the docs and a breaking change entry in the changelog. If `DataArray`s should be accepted, then we have a regression here.\r\n\r\nI may have time to help on this.\r\n\r\n### Environment\r\n\r\n<details>\r\n\r\nINSTALLED VERSIONS\r\n------------------\r\ncommit: None\r\npython: 3.9.6 | packaged by conda-forge | (default, Jul 11 2021, 03:39:48) \r\n[GCC 9.3.0]\r\npython-bits: 64\r\nOS: Linux\r\nOS-release: 5.16.13-arch1-1\r\nmachine: x86_64\r\nprocessor: \r\nbyteorder: little\r\nLC_ALL: None\r\nLANG: fr_CA.utf8\r\nLOCALE: ('fr_CA', 'UTF-8')\r\nlibhdf5: 1.12.0\r\nlibnetcdf: 4.7.4\r\n\r\nxarray: 2022.3.1.dev16+g3ead17ea\r\npandas: 1.4.0\r\nnumpy: 1.20.3\r\nscipy: 1.7.1\r\nnetCDF4: 1.5.7\r\npydap: None\r\nh5netcdf: 0.11.0\r\nh5py: 3.4.0\r\nNio: None\r\nzarr: 2.10.0\r\ncftime: 1.5.0\r\nnc_time_axis: 1.3.1\r\nPseudoNetCDF: None\r\nrasterio: None\r\ncfgrib: None\r\niris: None\r\nbottleneck: 1.3.2\r\ndask: 2021.08.0\r\ndistributed: 2021.08.0\r\nmatplotlib: 3.4.3\r\ncartopy: None\r\nseaborn: None\r\nnumbagg: None\r\nfsspec: 2021.07.0\r\ncupy: None\r\npint: 0.18\r\nsparse: None\r\nsetuptools: 57.4.0\r\npip: 21.2.4\r\nconda: None\r\npytest: 6.2.5\r\nIPython: 8.0.1\r\nsphinx: 4.1.2\r\n\r\n</details>\n",
  "hints_text": "",
  "created_at": "2022-03-20T17:06:13Z",
  "version": "2022.03",
  "FAIL_TO_PASS": "[\"xarray/tests/test_groupby.py::test_groupby_dataset_map_dataarray_func\"]",
  "PASS_TO_PASS": "[\"xarray/tests/test_groupby.py::test_consolidate_slices\", \"xarray/tests/test_groupby.py::test_groupby_dims_property\", \"xarray/tests/test_groupby.py::test_multi_index_groupby_map\", \"xarray/tests/test_groupby.py::test_multi_index_groupby_sum\", \"xarray/tests/test_groupby.py::test_groupby_da_datetime\", \"xarray/tests/test_groupby.py::test_groupby_duplicate_coordinate_labels\", \"xarray/tests/test_groupby.py::test_groupby_input_mutation\", \"xarray/tests/test_groupby.py::test_groupby_map_shrink_groups[obj0]\", \"xarray/tests/test_groupby.py::test_groupby_map_shrink_groups[obj1]\", \"xarray/tests/test_groupby.py::test_groupby_map_change_group_size[obj0]\", \"xarray/tests/test_groupby.py::test_groupby_map_change_group_size[obj1]\", \"xarray/tests/test_groupby.py::test_da_groupby_map_func_args\", \"xarray/tests/test_groupby.py::test_ds_groupby_map_func_args\", \"xarray/tests/test_groupby.py::test_da_groupby_empty\", \"xarray/tests/test_groupby.py::test_da_groupby_quantile\", \"xarray/tests/test_groupby.py::test_ds_groupby_quantile\", \"xarray/tests/test_groupby.py::test_groupby_quantile_interpolation_deprecated[False]\", \"xarray/tests/test_groupby.py::test_groupby_quantile_interpolation_deprecated[True]\", \"xarray/tests/test_groupby.py::test_da_groupby_assign_coords\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj0-x]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj0-y]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj0-z]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj0-month]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj1-x]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj1-y]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj1-z]\", \"xarray/tests/test_groupby.py::test_groupby_repr[obj1-month]\", \"xarray/tests/test_groupby.py::test_groupby_repr_datetime[obj0]\", \"xarray/tests/test_groupby.py::test_groupby_repr_datetime[obj1]\", \"xarray/tests/test_groupby.py::test_groupby_drops_nans\", \"xarray/tests/test_groupby.py::test_groupby_grouping_errors\", \"xarray/tests/test_groupby.py::test_groupby_reduce_dimension_error\", \"xarray/tests/test_groupby.py::test_groupby_multiple_string_args\", \"xarray/tests/test_groupby.py::test_groupby_bins_timeseries\", \"xarray/tests/test_groupby.py::test_groupby_none_group_name\", \"xarray/tests/test_groupby.py::test_groupby_getitem\", \"xarray/tests/test_groupby.py::test_groupby_dataset\", \"xarray/tests/test_groupby.py::test_groupby_dataset_returns_new_type\", \"xarray/tests/test_groupby.py::test_groupby_dataset_iter\", \"xarray/tests/test_groupby.py::test_groupby_dataset_errors\", \"xarray/tests/test_groupby.py::test_groupby_dataset_reduce\", \"xarray/tests/test_groupby.py::test_groupby_dataset_math[True]\", \"xarray/tests/test_groupby.py::test_groupby_dataset_math[False]\", \"xarray/tests/test_groupby.py::test_groupby_math_more\", \"xarray/tests/test_groupby.py::test_groupby_bins_math[True]\", \"xarray/tests/test_groupby.py::test_groupby_bins_math[False]\", \"xarray/tests/test_groupby.py::test_groupby_math_nD_group\", \"xarray/tests/test_groupby.py::test_groupby_dataset_math_virtual\", \"xarray/tests/test_groupby.py::test_groupby_dataset_nan\", \"xarray/tests/test_groupby.py::test_groupby_dataset_order\", \"xarray/tests/test_groupby.py::test_groupby_dataset_fillna\", \"xarray/tests/test_groupby.py::test_groupby_dataset_where\", \"xarray/tests/test_groupby.py::test_groupby_dataset_assign\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_stack_groupby_unsorted_coord\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_iter\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_properties\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_map_identity\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_sum\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_sum_default\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_count\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_map_center\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_map_ndarray\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_map_changes_metadata\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_math\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_math_not_aligned\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_restore_dim_order\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_restore_coord_dims\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_first_and_last\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_multidim\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_multidim_map\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_bins\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_bins_empty\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_bins_multidim\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_bins_sort\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_assign_coords\", \"xarray/tests/test_groupby.py::TestDataArrayGroupBy::test_groupby_fillna\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_da_resample_func_args\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample_first\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample_bad_resample_dim\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample_drop_nondim_coords\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample_keep_attrs\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_resample_skipna\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_nd\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_tolerance\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_interpolate\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_interpolate_bug_2197\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_interpolate_regression_1605\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_interpolate_dask[True]\", \"xarray/tests/test_groupby.py::TestDataArrayResample::test_upsample_interpolate_dask[False]\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_and_first\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_min_count\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_by_mean_with_keep_attrs\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_loffset\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_by_mean_discarding_attrs\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_by_last_discarding_attrs\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_drop_nondim_coords\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_old_api\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_resample_ds_da_are_the_same\", \"xarray/tests/test_groupby.py::TestDatasetResample::test_ds_resample_apply_func_args\"]",
  "environment_setup_commit": "d7931f9014a26e712ff5f30c4082cf0261f045d3",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.891976",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}