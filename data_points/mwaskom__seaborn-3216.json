{
  "repo": "mwaskom/seaborn",
  "instance_id": "mwaskom__seaborn-3216",
  "base_commit": "557b0d29cdeae9703576f4bb0eb73dd997a1e4a4",
  "patch": "diff --git a/seaborn/_compat.py b/seaborn/_compat.py\n--- a/seaborn/_compat.py\n+++ b/seaborn/_compat.py\n@@ -149,10 +149,14 @@ def set_layout_engine(fig, engine):\n     if hasattr(fig, \"set_layout_engine\"):\n         fig.set_layout_engine(engine)\n     else:\n+        # _version_predates(mpl, 3.6)\n         if engine == \"tight\":\n             fig.set_tight_layout(True)\n         elif engine == \"constrained\":\n             fig.set_constrained_layout(True)\n+        elif engine == \"none\":\n+            fig.set_tight_layout(False)\n+            fig.set_constrained_layout(False)\n \n \n def share_axis(ax0, ax1, which):\ndiff --git a/seaborn/_core/plot.py b/seaborn/_core/plot.py\n--- a/seaborn/_core/plot.py\n+++ b/seaborn/_core/plot.py\n@@ -1662,6 +1662,11 @@ def _finalize_figure(self, p: Plot) -> None:\n                 if axis_key in self._scales:  # TODO when would it not be?\n                     self._scales[axis_key]._finalize(p, axis_obj)\n \n-        engine_default = None if p._target is not None else \"tight\"\n-        layout_engine = p._layout_spec.get(\"engine\", engine_default)\n-        set_layout_engine(self._figure, layout_engine)\n+        if (engine := p._layout_spec.get(\"engine\", default)) is not default:\n+            # None is a valid arg for Figure.set_layout_engine, hence `default`\n+            set_layout_engine(self._figure, engine)\n+        elif p._target is None:\n+            # Don't modify the layout engine if the user supplied their own\n+            # matplotlib figure and didn't specify an engine through Plot\n+            # TODO switch default to \"constrained\"?\n+            set_layout_engine(self._figure, \"tight\")\n",
  "test_patch": "diff --git a/tests/_core/test_plot.py b/tests/_core/test_plot.py\n--- a/tests/_core/test_plot.py\n+++ b/tests/_core/test_plot.py\n@@ -1133,11 +1133,30 @@ def test_on_axes_with_subplots_error(self):\n         with pytest.raises(RuntimeError, match=\"Cannot create multiple subplots\"):\n             p2.plot()\n \n-    def test_on_disables_layout_algo(self):\n+    @pytest.mark.skipif(\n+        _version_predates(mpl, \"3.6\"),\n+        reason=\"Requires newer matplotlib layout engine API\"\n+    )\n+    def test_on_layout_algo_default(self):\n \n-        f = mpl.figure.Figure()\n+        class MockEngine(mpl.layout_engine.ConstrainedLayoutEngine):\n+            ...\n+\n+        f = mpl.figure.Figure(layout=MockEngine())\n         p = Plot().on(f).plot()\n-        assert not p._figure.get_tight_layout()\n+        layout_engine = p._figure.get_layout_engine()\n+        assert layout_engine.__class__.__name__ == \"MockEngine\"\n+\n+    @pytest.mark.skipif(\n+        _version_predates(mpl, \"3.6\"),\n+        reason=\"Requires newer matplotlib layout engine API\"\n+    )\n+    def test_on_layout_algo_spec(self):\n+\n+        f = mpl.figure.Figure(layout=\"constrained\")\n+        p = Plot().on(f).layout(engine=\"tight\").plot()\n+        layout_engine = p._figure.get_layout_engine()\n+        assert layout_engine.__class__.__name__ == \"TightLayoutEngine\"\n \n     def test_axis_labels_from_constructor(self, long_df):\n \n@@ -1383,7 +1402,7 @@ def test_layout_algo(self, algo):\n         p = Plot().facet([\"a\", \"b\"]).limit(x=(.1, .9))\n \n         p1 = p.layout(engine=algo).plot()\n-        p2 = p.layout(engine=None).plot()\n+        p2 = p.layout(engine=\"none\").plot()\n \n         # Force a draw (we probably need a method for this)\n         p1.save(io.BytesIO())\n",
  "problem_statement": "Figure title being removed by seaborn objects API when plotting on subfigures\nI recently came across an odd behaviour with the seaborn objects API when using subfigures. Here is a minimal example : \r\n```\r\nimport seaborn as sns\r\nimport seaborn.objects as so\r\nimport matplotlib.pyplot as plt\r\n\r\nfig = plt.figure(constrained_layout=True)\r\nsubfigs = fig.subfigures(1,2)\r\ntips = sns.load_dataset(\"tips\")\r\np = (\r\n    so.Plot(tips, \"total_bill\")\r\n    .add(so.Bars(), so.Hist())\r\n)\r\np.on(subfigs[0]).plot()\r\n\r\nax = subfigs[1].subplots()\r\nax.scatter([1],[1])\r\n\r\nfig.suptitle(\"Test title\")\r\nplt.show()\r\n```\r\nwhich results in the title missing from the image :\r\n![title_issue_bad](https://user-images.githubusercontent.com/1338337/210242982-57262fb0-d1d4-4aab-b400-8f59cae522f3.png)\r\n\r\nCommenting the `p.on(subfigs[0]).plot()` results in the title reappearing.\r\nI have done a bit of digging and found that changing  line 186 from the _core/subplots.py file from `figure = target.figure` to `figure = target` seems to solve the issue. Is there a specific reason to why it fetches the parent figure currently, since Subfigure is supposed to be a drop-in replacement for Figure ? I also expect this will not have the intended behaviour if we deal with subfigures of subfigures.\n",
  "hints_text": "I can replicate but am a little confused about what's happening. Is there a reason you think that the line you called out is the culprit, or were you just poking around? If you move the suptitle text over to a coordinate like (.98, 1) you can see that it's actually still there is something being plotted over it. And yet, modifying the zorder property doesn't seem to help.\r\n\r\n> Is there a specific reason to why it fetches the parent figure currently, since Subfigure is supposed to be a drop-in replacement for Figure ? \r\n\r\nUnfortunately this abstraction isn't perfect — the main methods that get called on the `Plotter._figure` object are `savefig` and `set_layout_engine`, which `SubFigure` doesn't have — I think there is a need to have a pointer to the parent figure, although maybe the behavior of `Plot.save` when it's being drawn on a subfigure is undefined. (Good point about the nested subplots edge case too).\nLooks like this is replicable with pure matplotlib:\r\n\r\n```python\r\nf = plt.figure()\r\nsfs = f.subfigures(1, 2)\r\nsfs[0].subplots()\r\nsfs[1].subplots()\r\nf.suptitle(\"Test title\")\r\n```\r\n![image](https://user-images.githubusercontent.com/315810/211165334-c97b95a9-aea6-40ab-9c03-4e75836ca0eb.png)\r\n\nReported upstream to matplotlib: https://github.com/matplotlib/matplotlib/issues/24910\nHowever to OP was using constrained_layout and in pure matplotlib it does:\r\n\r\n```python\r\nf = plt.figure()\r\nsfs = f.subfigures(1, 2, layout='constrained')\r\nsfs[0].subplots()\r\nsfs[1].subplots()\r\nf.suptitle(\"Test title\")\r\n```\r\n\r\n![Suptitle](https://user-images.githubusercontent.com/1562854/211210932-1113b4d0-0f66-47a8-89b4-4c04dd8d05b8.png)\r\n\r\nDoes the `Plot` object call `plt.tight_layout`?  That will override constrained_layout.  \r\n\r\n",
  "created_at": "2023-01-08T23:34:46Z",
  "version": "0.13",
  "FAIL_TO_PASS": "[\"tests/_core/test_plot.py::TestPlotting::test_on_layout_algo_default\"]",
  "PASS_TO_PASS": "[\"tests/_core/test_plot.py::TestInit::test_empty\", \"tests/_core/test_plot.py::TestInit::test_data_only\", \"tests/_core/test_plot.py::TestInit::test_df_and_named_variables\", \"tests/_core/test_plot.py::TestInit::test_df_and_mixed_variables\", \"tests/_core/test_plot.py::TestInit::test_vector_variables_only\", \"tests/_core/test_plot.py::TestInit::test_vector_variables_no_index\", \"tests/_core/test_plot.py::TestInit::test_data_only_named\", \"tests/_core/test_plot.py::TestInit::test_positional_and_named_data\", \"tests/_core/test_plot.py::TestInit::test_positional_and_named_xy[x]\", \"tests/_core/test_plot.py::TestInit::test_positional_and_named_xy[y]\", \"tests/_core/test_plot.py::TestInit::test_positional_data_x_y\", \"tests/_core/test_plot.py::TestInit::test_positional_x_y\", \"tests/_core/test_plot.py::TestInit::test_positional_data_x\", \"tests/_core/test_plot.py::TestInit::test_positional_x\", \"tests/_core/test_plot.py::TestInit::test_positional_too_many\", \"tests/_core/test_plot.py::TestInit::test_unknown_keywords\", \"tests/_core/test_plot.py::TestLayerAddition::test_without_data\", \"tests/_core/test_plot.py::TestLayerAddition::test_with_new_variable_by_name\", \"tests/_core/test_plot.py::TestLayerAddition::test_with_new_variable_by_vector\", \"tests/_core/test_plot.py::TestLayerAddition::test_with_late_data_definition\", \"tests/_core/test_plot.py::TestLayerAddition::test_with_new_data_definition\", \"tests/_core/test_plot.py::TestLayerAddition::test_drop_variable\", \"tests/_core/test_plot.py::TestLayerAddition::test_stat_nondefault\", \"tests/_core/test_plot.py::TestLayerAddition::test_orient[x-x]\", \"tests/_core/test_plot.py::TestLayerAddition::test_orient[y-y]\", \"tests/_core/test_plot.py::TestLayerAddition::test_orient[v-x]\", \"tests/_core/test_plot.py::TestLayerAddition::test_orient[h-y]\", \"tests/_core/test_plot.py::TestLayerAddition::test_variable_list\", \"tests/_core/test_plot.py::TestLayerAddition::test_type_checks\", \"tests/_core/test_plot.py::TestScaling::test_inference\", \"tests/_core/test_plot.py::TestScaling::test_inference_from_layer_data\", \"tests/_core/test_plot.py::TestScaling::test_inference_joins\", \"tests/_core/test_plot.py::TestScaling::test_inferred_categorical_converter\", \"tests/_core/test_plot.py::TestScaling::test_explicit_categorical_converter\", \"tests/_core/test_plot.py::TestScaling::test_faceted_log_scale\", \"tests/_core/test_plot.py::TestScaling::test_paired_single_log_scale\", \"tests/_core/test_plot.py::TestScaling::test_mark_data_log_transform_is_inverted\", \"tests/_core/test_plot.py::TestScaling::test_mark_data_log_transfrom_with_stat\", \"tests/_core/test_plot.py::TestScaling::test_mark_data_from_categorical\", \"tests/_core/test_plot.py::TestScaling::test_mark_data_from_datetime\", \"tests/_core/test_plot.py::TestScaling::test_computed_var_ticks\", \"tests/_core/test_plot.py::TestScaling::test_computed_var_transform\", \"tests/_core/test_plot.py::TestScaling::test_explicit_range_with_axis_scaling\", \"tests/_core/test_plot.py::TestScaling::test_derived_range_with_axis_scaling\", \"tests/_core/test_plot.py::TestScaling::test_facet_categories\", \"tests/_core/test_plot.py::TestScaling::test_facet_categories_unshared\", \"tests/_core/test_plot.py::TestScaling::test_facet_categories_single_dim_shared\", \"tests/_core/test_plot.py::TestScaling::test_pair_categories\", \"tests/_core/test_plot.py::TestScaling::test_pair_categories_shared\", \"tests/_core/test_plot.py::TestScaling::test_identity_mapping_linewidth\", \"tests/_core/test_plot.py::TestScaling::test_pair_single_coordinate_stat_orient\", \"tests/_core/test_plot.py::TestScaling::test_inferred_nominal_passed_to_stat\", \"tests/_core/test_plot.py::TestScaling::test_identity_mapping_color_tuples\", \"tests/_core/test_plot.py::TestScaling::test_nominal_x_axis_tweaks\", \"tests/_core/test_plot.py::TestScaling::test_nominal_y_axis_tweaks\", \"tests/_core/test_plot.py::TestPlotting::test_matplotlib_object_creation\", \"tests/_core/test_plot.py::TestPlotting::test_empty\", \"tests/_core/test_plot.py::TestPlotting::test_no_orient_variance\", \"tests/_core/test_plot.py::TestPlotting::test_single_split_single_layer\", \"tests/_core/test_plot.py::TestPlotting::test_single_split_multi_layer\", \"tests/_core/test_plot.py::TestPlotting::test_one_grouping_variable[color]\", \"tests/_core/test_plot.py::TestPlotting::test_one_grouping_variable[group]\", \"tests/_core/test_plot.py::TestPlotting::test_two_grouping_variables\", \"tests/_core/test_plot.py::TestPlotting::test_specified_width\", \"tests/_core/test_plot.py::TestPlotting::test_facets_no_subgroups\", \"tests/_core/test_plot.py::TestPlotting::test_facets_one_subgroup\", \"tests/_core/test_plot.py::TestPlotting::test_layer_specific_facet_disabling\", \"tests/_core/test_plot.py::TestPlotting::test_paired_variables\", \"tests/_core/test_plot.py::TestPlotting::test_paired_one_dimension\", \"tests/_core/test_plot.py::TestPlotting::test_paired_variables_one_subset\", \"tests/_core/test_plot.py::TestPlotting::test_paired_and_faceted\", \"tests/_core/test_plot.py::TestPlotting::test_theme_default\", \"tests/_core/test_plot.py::TestPlotting::test_theme_params\", \"tests/_core/test_plot.py::TestPlotting::test_theme_error\", \"tests/_core/test_plot.py::TestPlotting::test_stat\", \"tests/_core/test_plot.py::TestPlotting::test_move\", \"tests/_core/test_plot.py::TestPlotting::test_stat_and_move\", \"tests/_core/test_plot.py::TestPlotting::test_stat_log_scale\", \"tests/_core/test_plot.py::TestPlotting::test_move_log_scale\", \"tests/_core/test_plot.py::TestPlotting::test_multi_move\", \"tests/_core/test_plot.py::TestPlotting::test_multi_move_with_pairing\", \"tests/_core/test_plot.py::TestPlotting::test_move_with_range\", \"tests/_core/test_plot.py::TestPlotting::test_methods_clone\", \"tests/_core/test_plot.py::TestPlotting::test_default_is_no_pyplot\", \"tests/_core/test_plot.py::TestPlotting::test_with_pyplot\", \"tests/_core/test_plot.py::TestPlotting::test_show\", \"tests/_core/test_plot.py::TestPlotting::test_png_repr\", \"tests/_core/test_plot.py::TestPlotting::test_save\", \"tests/_core/test_plot.py::TestPlotting::test_layout_size\", \"tests/_core/test_plot.py::TestPlotting::test_on_axes\", \"tests/_core/test_plot.py::TestPlotting::test_on_figure[True]\", \"tests/_core/test_plot.py::TestPlotting::test_on_figure[False]\", \"tests/_core/test_plot.py::TestPlotting::test_on_subfigure[True]\", \"tests/_core/test_plot.py::TestPlotting::test_on_subfigure[False]\", \"tests/_core/test_plot.py::TestPlotting::test_on_type_check\", \"tests/_core/test_plot.py::TestPlotting::test_on_axes_with_subplots_error\", \"tests/_core/test_plot.py::TestPlotting::test_on_layout_algo_spec\", \"tests/_core/test_plot.py::TestPlotting::test_axis_labels_from_constructor\", \"tests/_core/test_plot.py::TestPlotting::test_axis_labels_from_layer\", \"tests/_core/test_plot.py::TestPlotting::test_axis_labels_are_first_name\", \"tests/_core/test_plot.py::TestPlotting::test_limits\", \"tests/_core/test_plot.py::TestPlotting::test_labels_axis\", \"tests/_core/test_plot.py::TestPlotting::test_labels_legend\", \"tests/_core/test_plot.py::TestPlotting::test_labels_facets\", \"tests/_core/test_plot.py::TestPlotting::test_title_single\", \"tests/_core/test_plot.py::TestPlotting::test_title_facet_function\", \"tests/_core/test_plot.py::TestExceptions::test_scale_setup\", \"tests/_core/test_plot.py::TestExceptions::test_coordinate_scaling\", \"tests/_core/test_plot.py::TestExceptions::test_semantic_scaling\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d[row]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_as_vector[row]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[row-reverse]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[col-reverse]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d[col]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_as_vector[col]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[col-subset]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[row-subset]\", \"tests/_core/test_plot.py::TestFacetInterface::test_2d_with_order[subset]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[col-expand]\", \"tests/_core/test_plot.py::TestFacetInterface::test_1d_with_order[row-expand]\", \"tests/_core/test_plot.py::TestFacetInterface::test_2d_with_order[expand]\", \"tests/_core/test_plot.py::TestFacetInterface::test_2d_with_order[reverse]\", \"tests/_core/test_plot.py::TestFacetInterface::test_2d\", \"tests/_core/test_plot.py::TestFacetInterface::test_layout_algo[tight]\", \"tests/_core/test_plot.py::TestFacetInterface::test_layout_algo[constrained]\", \"tests/_core/test_plot.py::TestFacetInterface::test_axis_sharing\", \"tests/_core/test_plot.py::TestFacetInterface::test_unshared_spacing\", \"tests/_core/test_plot.py::TestFacetInterface::test_col_wrapping\", \"tests/_core/test_plot.py::TestFacetInterface::test_row_wrapping\", \"tests/_core/test_plot.py::TestPairInterface::test_all_numeric[list]\", \"tests/_core/test_plot.py::TestPairInterface::test_all_numeric[Index]\", \"tests/_core/test_plot.py::TestPairInterface::test_single_variable_key_raises\", \"tests/_core/test_plot.py::TestPairInterface::test_single_dimension[x]\", \"tests/_core/test_plot.py::TestPairInterface::test_single_dimension[y]\", \"tests/_core/test_plot.py::TestPairInterface::test_non_cross\", \"tests/_core/test_plot.py::TestPairInterface::test_list_of_vectors\", \"tests/_core/test_plot.py::TestPairInterface::test_with_no_variables\", \"tests/_core/test_plot.py::TestPairInterface::test_with_facets\", \"tests/_core/test_plot.py::TestPairInterface::test_error_on_facet_overlap[variables0]\", \"tests/_core/test_plot.py::TestPairInterface::test_error_on_facet_overlap[variables1]\", \"tests/_core/test_plot.py::TestPairInterface::test_error_on_wrap_overlap[variables0]\", \"tests/_core/test_plot.py::TestPairInterface::test_error_on_wrap_overlap[variables1]\", \"tests/_core/test_plot.py::TestPairInterface::test_axis_sharing\", \"tests/_core/test_plot.py::TestPairInterface::test_axis_sharing_with_facets\", \"tests/_core/test_plot.py::TestPairInterface::test_x_wrapping\", \"tests/_core/test_plot.py::TestPairInterface::test_y_wrapping\", \"tests/_core/test_plot.py::TestPairInterface::test_non_cross_wrapping\", \"tests/_core/test_plot.py::TestPairInterface::test_cross_mismatched_lengths\", \"tests/_core/test_plot.py::TestPairInterface::test_orient_inference\", \"tests/_core/test_plot.py::TestPairInterface::test_computed_coordinate_orient_inference\", \"tests/_core/test_plot.py::TestPairInterface::test_two_variables_single_order_error\", \"tests/_core/test_plot.py::TestPairInterface::test_limits\", \"tests/_core/test_plot.py::TestPairInterface::test_labels\", \"tests/_core/test_plot.py::TestLabelVisibility::test_single_subplot\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_column[facet_kws0-pair_kws0]\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_column[facet_kws1-pair_kws1]\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_row[facet_kws0-pair_kws0]\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_row[facet_kws1-pair_kws1]\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_column_wrapped\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_row_wrapped\", \"tests/_core/test_plot.py::TestLabelVisibility::test_1d_column_wrapped_non_cross\", \"tests/_core/test_plot.py::TestLabelVisibility::test_2d\", \"tests/_core/test_plot.py::TestLabelVisibility::test_2d_unshared\", \"tests/_core/test_plot.py::TestLegend::test_single_layer_single_variable\", \"tests/_core/test_plot.py::TestLegend::test_single_layer_common_variable\", \"tests/_core/test_plot.py::TestLegend::test_single_layer_common_unnamed_variable\", \"tests/_core/test_plot.py::TestLegend::test_single_layer_multi_variable\", \"tests/_core/test_plot.py::TestLegend::test_multi_layer_single_variable\", \"tests/_core/test_plot.py::TestLegend::test_multi_layer_multi_variable\", \"tests/_core/test_plot.py::TestLegend::test_multi_layer_different_artists\", \"tests/_core/test_plot.py::TestLegend::test_three_layers\", \"tests/_core/test_plot.py::TestLegend::test_identity_scale_ignored\", \"tests/_core/test_plot.py::TestLegend::test_suppression_in_add_method\", \"tests/_core/test_plot.py::TestLegend::test_anonymous_title\", \"tests/_core/test_plot.py::TestLegend::test_legendless_mark\", \"tests/_core/test_plot.py::TestLegend::test_legend_has_no_offset\", \"tests/_core/test_plot.py::TestDefaultObject::test_default_repr\"]",
  "environment_setup_commit": "23860365816440b050e9211e1c395a966de3c403",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.838311",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}