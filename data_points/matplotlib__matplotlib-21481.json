{
  "repo": "matplotlib/matplotlib",
  "instance_id": "matplotlib__matplotlib-21481",
  "base_commit": "d448de31b7deaec8310caaf8bba787e097bf9211",
  "patch": "diff --git a/lib/matplotlib/_layoutgrid.py b/lib/matplotlib/_layoutgrid.py\n--- a/lib/matplotlib/_layoutgrid.py\n+++ b/lib/matplotlib/_layoutgrid.py\n@@ -169,7 +169,8 @@ def hard_constraints(self):\n                 self.solver.addConstraint(c | 'required')\n \n     def add_child(self, child, i=0, j=0):\n-        self.children[i, j] = child\n+        # np.ix_ returns the cross product of i and j indices\n+        self.children[np.ix_(np.atleast_1d(i), np.atleast_1d(j))] = child\n \n     def parent_constraints(self):\n         # constraints that are due to the parent...\n",
  "test_patch": "diff --git a/lib/matplotlib/tests/test_constrainedlayout.py b/lib/matplotlib/tests/test_constrainedlayout.py\n--- a/lib/matplotlib/tests/test_constrainedlayout.py\n+++ b/lib/matplotlib/tests/test_constrainedlayout.py\n@@ -560,3 +560,10 @@ def test_suplabels():\n     pos = ax.get_tightbbox(fig.canvas.get_renderer())\n     assert pos.y0 > pos0.y0 + 10.0\n     assert pos.x0 > pos0.x0 + 10.0\n+\n+\n+def test_gridspec_addressing():\n+    fig = plt.figure()\n+    gs = fig.add_gridspec(3, 3)\n+    sp = fig.add_subplot(gs[0:, 1:])\n+    fig.draw_without_rendering()\ndiff --git a/lib/matplotlib/tests/test_figure.py b/lib/matplotlib/tests/test_figure.py\n--- a/lib/matplotlib/tests/test_figure.py\n+++ b/lib/matplotlib/tests/test_figure.py\n@@ -1073,6 +1073,7 @@ def test_subfigure_spanning():\n         fig.add_subfigure(gs[0, 0]),\n         fig.add_subfigure(gs[0:2, 1]),\n         fig.add_subfigure(gs[2, 1:3]),\n+        fig.add_subfigure(gs[0:, 1:])\n     ]\n \n     w = 640\n@@ -1086,6 +1087,12 @@ def test_subfigure_spanning():\n     np.testing.assert_allclose(sub_figs[2].bbox.min, [w / 3, 0])\n     np.testing.assert_allclose(sub_figs[2].bbox.max, [w, h / 3])\n \n+    # check here that slicing actually works.  Last sub_fig\n+    # with open slices failed, but only on draw...\n+    for i in range(4):\n+        sub_figs[i].add_subplot()\n+    fig.draw_without_rendering()\n+\n \n @mpl.style.context('mpl20')\n def test_subfigure_ticks():\n",
  "problem_statement": "[Bug]: Subfigure breaks for some `Gridspec` slices when using `constrained_layout`\n### Bug summary\n\nWhen creating a figure with `constrained_layout=True` you cannot use arbitrary gridspecs to create subfigures as it throws an error at some point ( I think once the layout manager actually takes effect?). This happened immediately on the `add_subfigure` call in `3.4.3` and only on the `add_subplot` call on `main`\n\n### Code for reproduction\n\n```python\nimport matplotlib.pyplot as plt\r\nfig = plt.figure(constrained_layout=True)\r\ngs = fig.add_gridspec(3, 3)\r\nsubfig = fig.add_subfigure(gs[0:, 1:])\r\nsubfig.add_subplot()\n```\n\n\n### Actual outcome\n\n```\r\nTraceback (most recent call last):\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/backends/backend_qt.py\", line 455, in _draw_idle\r\n    self.draw()\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/backends/backend_agg.py\", line 436, in draw\r\n    self.figure.draw(self.renderer)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/artist.py\", line 73, in draw_wrapper\r\n    result = draw(artist, renderer, *args, **kwargs)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/artist.py\", line 50, in draw_wrapper\r\n    return draw(artist, renderer)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/figure.py\", line 2795, in draw\r\n    self.execute_constrained_layout(renderer)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/figure.py\", line 3153, in execute_constrained_layout\r\n    return do_constrained_layout(fig, renderer, h_pad, w_pad,\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/_constrained_layout.py\", line 95, in do_constrained_layout\r\n    layoutgrids = make_layoutgrids(fig, None)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/_constrained_layout.py\", line 167, in make_layoutgrids\r\n    layoutgrids = make_layoutgrids(sfig, layoutgrids)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/_constrained_layout.py\", line 158, in make_layoutgrids\r\n    layoutgrids[fig] = mlayoutgrid.LayoutGrid(\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/_layoutgrid.py\", line 59, in __init__\r\n    parent.add_child(self, *parent_pos)\r\n  File \"/home/ian/Documents/oss/matplotlib/matplotlib/lib/matplotlib/_layoutgrid.py\", line 172, in add_child\r\n    self.children[i, j] = child\r\nIndexError: shape mismatch: indexing arrays could not be broadcast together with shapes (3,) (2,) \r\n```\n\n### Expected outcome\n\nNo error. Should be the same as with `constrained_layout=False`\n\n### Operating system\n\nUbuntu\n\n### Matplotlib Version\n\n3.5.0.dev2428+g8daad3364a\n\n### Matplotlib Backend\n\nQtAgg\n\n### Python version\n\n3.9.2\n\n### Jupyter version\n\n_No response_\n\n### Other libraries\n\n_No response_\n\n### Installation\n\nsource\n\n### Conda channel\n\n_No response_\n",
  "hints_text": "Not 100% sure what is going on, but pretty sure we never tested add_subfigure on arbitrary gridspec slices.  Maybe it can be made to work, but you may be stretching the limits of what is possible.  \n\nFor the layout above I'm not sure why you don't just have two columns.  But maybe that si just a simple example.  ",
  "created_at": "2021-10-28T08:05:46Z",
  "version": "3.4",
  "FAIL_TO_PASS": "[\"lib/matplotlib/tests/test_figure.py::test_subfigure_spanning\"]",
  "PASS_TO_PASS": "[\"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout1[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout2[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout3[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout4[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout5[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout6[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout7\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout8[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout9[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout10[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout11[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout11rat[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout12[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout13[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout14[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout15[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout16[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout17[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout18\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout19\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout20\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout21\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout22\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_constrained_layout23\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_colorbar_location[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_hidden_axes\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_colorbar_align\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_colorbars_no_overlapV[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_colorbars_no_overlapH[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_manually_set_position\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_bboxtight[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_bbox[png]\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_align_labels\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_suplabels\", \"lib/matplotlib/tests/test_constrainedlayout.py::test_gridspec_addressing\", \"lib/matplotlib/tests/test_figure.py::test_align_labels[png]\", \"lib/matplotlib/tests/test_figure.py::test_figure_label\", \"lib/matplotlib/tests/test_figure.py::test_fignum_exists\", \"lib/matplotlib/tests/test_figure.py::test_clf_keyword\", \"lib/matplotlib/tests/test_figure.py::test_figure[png]\", \"lib/matplotlib/tests/test_figure.py::test_figure[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_figure_legend[png]\", \"lib/matplotlib/tests/test_figure.py::test_figure_legend[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_gca\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_subclass\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_invalid\", \"lib/matplotlib/tests/test_figure.py::test_suptitle[png]\", \"lib/matplotlib/tests/test_figure.py::test_suptitle[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_suptitle_fontproperties\", \"lib/matplotlib/tests/test_figure.py::test_alpha[png]\", \"lib/matplotlib/tests/test_figure.py::test_too_many_figures\", \"lib/matplotlib/tests/test_figure.py::test_iterability_axes_argument\", \"lib/matplotlib/tests/test_figure.py::test_set_fig_size\", \"lib/matplotlib/tests/test_figure.py::test_axes_remove\", \"lib/matplotlib/tests/test_figure.py::test_figaspect\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[both]\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[major]\", \"lib/matplotlib/tests/test_figure.py::test_autofmt_xdate[minor]\", \"lib/matplotlib/tests/test_figure.py::test_change_dpi\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[1-nan]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[-1-1]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_size[inf-1]\", \"lib/matplotlib/tests/test_figure.py::test_invalid_figure_add_axes\", \"lib/matplotlib/tests/test_figure.py::test_subplots_shareax_loglabels\", \"lib/matplotlib/tests/test_figure.py::test_savefig\", \"lib/matplotlib/tests/test_figure.py::test_savefig_warns\", \"lib/matplotlib/tests/test_figure.py::test_savefig_backend\", \"lib/matplotlib/tests/test_figure.py::test_savefig_pixel_ratio[Agg]\", \"lib/matplotlib/tests/test_figure.py::test_figure_repr\", \"lib/matplotlib/tests/test_figure.py::test_valid_layouts\", \"lib/matplotlib/tests/test_figure.py::test_invalid_layouts\", \"lib/matplotlib/tests/test_figure.py::test_add_artist[png]\", \"lib/matplotlib/tests/test_figure.py::test_add_artist[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[png]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[ps]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[eps]\", \"lib/matplotlib/tests/test_figure.py::test_fspath[svg]\", \"lib/matplotlib/tests/test_figure.py::test_tightbbox\", \"lib/matplotlib/tests/test_figure.py::test_axes_removal\", \"lib/matplotlib/tests/test_figure.py::test_removed_axis\", \"lib/matplotlib/tests/test_figure.py::test_picking_does_not_stale\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_twotuple\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[pdf]\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[eps]\", \"lib/matplotlib/tests/test_figure.py::test_animated_with_canvas_change[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_basic[x1-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_all_nested[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_tuple[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x0-None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x1-SKIP-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x2-0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x3-None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x4-SKIP-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_empty[x5-0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail_list_of_str\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[subplot_kw0-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[subplot_kw1-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_subplot_kw[None-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_string_parser\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[AAA\\\\nBBB-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[\\\\nAAA\\\\nBBB\\\\n-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_single_str_input[ABC\\\\nDEF-png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x0-(?m)we\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x1-There\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[AAA\\\\nc\\\\nBBB-All\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_fail[x3-All\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_hashable_keys[png]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[abc]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[cab]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[bca]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[cba]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[acb]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_user_order[bac]\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_nested_user_order\", \"lib/matplotlib/tests/test_figure.py::TestSubplotMosaic::test_share_all\", \"lib/matplotlib/tests/test_figure.py::test_reused_gridspec\", \"lib/matplotlib/tests/test_figure.py::test_subfigure[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_tightbbox\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_ss[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_double[png]\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_ticks\", \"lib/matplotlib/tests/test_figure.py::test_subfigure_scatter_size[png]\", \"lib/matplotlib/tests/test_figure.py::test_add_subplot_kwargs\", \"lib/matplotlib/tests/test_figure.py::test_add_axes_kwargs\", \"lib/matplotlib/tests/test_figure.py::test_ginput\", \"lib/matplotlib/tests/test_figure.py::test_waitforbuttonpress\", \"lib/matplotlib/tests/test_figure.py::test_kwargs_pass\"]",
  "environment_setup_commit": "f93c0a3dcb82feed0262d758626c90d4002685f3",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.792876",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}