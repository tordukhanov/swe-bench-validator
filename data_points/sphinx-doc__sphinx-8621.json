{
  "repo": "sphinx-doc/sphinx",
  "instance_id": "sphinx-doc__sphinx-8621",
  "base_commit": "21698c14461d27933864d73e6fba568a154e83b3",
  "patch": "diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py\n--- a/sphinx/builders/html/transforms.py\n+++ b/sphinx/builders/html/transforms.py\n@@ -37,7 +37,7 @@ class KeyboardTransform(SphinxPostTransform):\n     \"\"\"\n     default_priority = 400\n     builders = ('html',)\n-    pattern = re.compile(r'(-|\\+|\\^|\\s+)')\n+    pattern = re.compile(r'(?<=.)(-|\\+|\\^|\\s+)(?=.)')\n \n     def run(self, **kwargs: Any) -> None:\n         matcher = NodeMatcher(nodes.literal, classes=[\"kbd\"])\n",
  "test_patch": "diff --git a/tests/test_markup.py b/tests/test_markup.py\n--- a/tests/test_markup.py\n+++ b/tests/test_markup.py\n@@ -251,6 +251,17 @@ def get(name):\n          '</kbd></p>'),\n         '\\\\sphinxkeyboard{\\\\sphinxupquote{Control+X}}',\n     ),\n+    (\n+        # kbd role\n+        'verify',\n+        ':kbd:`Alt+^`',\n+        ('<p><kbd class=\"kbd docutils literal notranslate\">'\n+         '<kbd class=\"kbd docutils literal notranslate\">Alt</kbd>'\n+         '+'\n+         '<kbd class=\"kbd docutils literal notranslate\">^</kbd>'\n+         '</kbd></p>'),\n+        '\\\\sphinxkeyboard{\\\\sphinxupquote{Alt+\\\\textasciicircum{}}}',\n+    ),\n     (\n         # kbd role\n         'verify',\n@@ -266,6 +277,13 @@ def get(name):\n          '</kbd></p>'),\n         '\\\\sphinxkeyboard{\\\\sphinxupquote{M\\\\sphinxhyphen{}x  M\\\\sphinxhyphen{}s}}',\n     ),\n+    (\n+        # kbd role\n+        'verify',\n+        ':kbd:`-`',\n+        '<p><kbd class=\"kbd docutils literal notranslate\">-</kbd></p>',\n+        '\\\\sphinxkeyboard{\\\\sphinxupquote{\\\\sphinxhyphen{}}}',\n+    ),\n     (\n         # non-interpolation of dashes in option role\n         'verify_re',\n",
  "problem_statement": "kbd role produces incorrect HTML when compound-key separators (-, + or ^) are used as keystrokes\n**Describe the bug**\r\n\r\nThe `:kbd:` role produces incorrect HTML when:\r\n\r\n1) defining standalone keystrokes that use any of the compound-key separators (`-`, `+` and `^`)\r\n2) defining compound keystrokes where one or more keystrokes use any of the compound-key separators (`-`, `+` and `^`)\r\n\r\n**To Reproduce**\r\n\r\nFor the below three keyboard definitions:\r\n```\r\n(1) :kbd:`-`\r\n(2) :kbd:`+`\r\n(3) :kbd:`Shift-+`\r\n```\r\n\r\nThe following three incorrect output is generated:\r\n\r\n(1) `-` is treated as a separator with two \"blank\" keystrokes around it.\r\n\r\n```\r\n<kbd class=\"kbd docutils literal notranslate\"><kbd class=\"kbd docutils literal notranslate\"></kbd>-<kbd class=\"kbd docutils literal notranslate\"></kbd></kbd>\r\n```\r\n\r\n(2) `+` is treated as a separator with two \"blank\" keystrokes around it.\r\n\r\n```\r\n<kbd class=\"kbd docutils literal notranslate\"><kbd class=\"kbd docutils literal notranslate\"></kbd>+<kbd class=\"kbd docutils literal notranslate\"></kbd></kbd>\r\n```\r\n\r\n(3) `+` is treated as a separator within a compound-keystroke, with two \"blank\" keystrokes around it.\r\n\r\n```\r\n<kbd class=\"kbd docutils literal notranslate\"><kbd class=\"kbd docutils literal notranslate\">Shift</kbd>-<kbd class=\"kbd docutils literal notranslate\"></kbd>+<kbd class=\"kbd docutils literal notranslate\"></kbd></kbd>\r\n```\r\n\r\n**Expected behavior**\r\n\r\nFor single keystrokes that use `-`, `+` or`^`, just a single `kbd` element should be created.\r\n\r\nFor compound-keystrokes, the algorithm should differentiate between `-`, `+` and `^` characters appearing in separator vs keystroke positions (currently, it's very simplistic, it just treats all these characters as separators using a simple regexp).\r\n\r\n**Screenshot**\r\n\r\n![image](https://user-images.githubusercontent.com/698770/103331652-a2268680-4ab2-11eb-953a-2f50c8cb7a00.png)\r\n\r\n\r\n**Environment info**\r\n- OS: Windows\r\n- Python version: 3.9.1\r\n- Sphinx version: 3.4.0\r\n- Sphinx extensions:  -\r\n- Extra tools: -\r\n\n",
  "hints_text": "",
  "created_at": "2020-12-30T12:13:09Z",
  "version": "3.5",
  "FAIL_TO_PASS": "[\"tests/test_markup.py::test_inline[verify-:kbd:`Alt+^`-<p><kbd\", \"tests/test_markup.py::test_inline[verify-:kbd:`-`-<p><kbd\"]",
  "PASS_TO_PASS": "[\"tests/test_markup.py::test_inline[verify-:rfc:`2324`-<p><span\", \"tests/test_markup.py::test_inline[verify-:rfc:`2324#id1`-<p><span\", \"tests/test_markup.py::test_inline[verify_re-``code\", \"tests/test_markup.py::test_inline[verify-:menuselection:`a\", \"tests/test_markup.py::test_inline[verify-:menuselection:`&Foo\", \"tests/test_markup.py::test_inline[verify-:guilabel:`&Foo\", \"tests/test_markup.py::test_inline[verify-:guilabel:`Foo`-<p><span\", \"tests/test_markup.py::test_inline[verify-:kbd:`space`-<p><kbd\", \"tests/test_markup.py::test_inline[verify-:kbd:`Control+X`-<p><kbd\", \"tests/test_markup.py::test_inline[verify-:kbd:`M-x\", \"tests/test_markup.py::test_inline[verify_re-:option:`--with-option`-<p><code(\", \"tests/test_markup.py::test_inline[verify-\\\"John\\\"-<p>\\\\u201cJohn\\\\u201d</p>-\\\\u201cJohn\\\\u201d]\", \"tests/test_markup.py::test_inline[verify-``\\\"John\\\"``-<p><code\", \"tests/test_markup.py::test_inline[verify-:manpage:`mp(1)`-<p><em\", \"tests/test_markup.py::test_inline[verify-\\\\u0393\\\\\\\\\\\\\\\\\\\\u221e$-None-\\\\u0393\\\\\\\\textbackslash{}\\\\\\\\(\\\\\\\\infty\\\\\\\\)\\\\\\\\$]\", \"tests/test_markup.py::test_inline[verify-::\\\\n\\\\n\", \"tests/test_markup.py::test_inline[verify_re-`test\", \"tests/test_markup.py::test_inline[verify-term\\\\n\", \"tests/test_markup.py::test_inline[verify-term\", \"tests/test_markup.py::test_inline[verify-..\", \"tests/test_markup.py::test_inline_docutils16[verify-4\", \"tests/test_markup.py::test_inline_for_unicode_latex_engine[verify-::\\\\n\\\\n\", \"tests/test_markup.py::test_samp_role\", \"tests/test_markup.py::test_download_role\", \"tests/test_markup.py::test_XRefRole\", \"tests/test_markup.py::test_rst_prolog\", \"tests/test_markup.py::test_keep_warnings_is_True\", \"tests/test_markup.py::test_keep_warnings_is_False\", \"tests/test_markup.py::test_compact_refonly_bullet_list\", \"tests/test_markup.py::test_default_role1\", \"tests/test_markup.py::test_default_role2\"]",
  "environment_setup_commit": "4f8cb861e3b29186b38248fe81e4944fd987fcce",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:31.057803",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}