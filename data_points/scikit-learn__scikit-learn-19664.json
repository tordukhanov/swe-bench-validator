{
  "repo": "scikit-learn/scikit-learn",
  "instance_id": "scikit-learn__scikit-learn-19664",
  "base_commit": "2620a5545a806ee416d9d10e07c2de30cdd9bf20",
  "patch": "diff --git a/sklearn/semi_supervised/_label_propagation.py b/sklearn/semi_supervised/_label_propagation.py\n--- a/sklearn/semi_supervised/_label_propagation.py\n+++ b/sklearn/semi_supervised/_label_propagation.py\n@@ -241,7 +241,7 @@ def fit(self, X, y):\n \n         Parameters\n         ----------\n-        X : array-like of shape (n_samples, n_features)\n+        X : {array-like, sparse matrix} of shape (n_samples, n_features)\n             Training data, where `n_samples` is the number of samples\n             and `n_features` is the number of features.\n \n@@ -256,7 +256,12 @@ def fit(self, X, y):\n             Returns the instance itself.\n         \"\"\"\n         self._validate_params()\n-        X, y = self._validate_data(X, y)\n+        X, y = self._validate_data(\n+            X,\n+            y,\n+            accept_sparse=[\"csr\", \"csc\"],\n+            reset=True,\n+        )\n         self.X_ = X\n         check_classification_targets(y)\n \n@@ -365,7 +370,7 @@ class LabelPropagation(BaseLabelPropagation):\n \n     Attributes\n     ----------\n-    X_ : ndarray of shape (n_samples, n_features)\n+    X_ : {array-like, sparse matrix} of shape (n_samples, n_features)\n         Input array.\n \n     classes_ : ndarray of shape (n_classes,)\n@@ -463,7 +468,7 @@ def fit(self, X, y):\n \n         Parameters\n         ----------\n-        X : array-like of shape (n_samples, n_features)\n+        X : {array-like, sparse matrix} of shape (n_samples, n_features)\n             Training data, where `n_samples` is the number of samples\n             and `n_features` is the number of features.\n \n",
  "test_patch": "diff --git a/sklearn/semi_supervised/tests/test_label_propagation.py b/sklearn/semi_supervised/tests/test_label_propagation.py\n--- a/sklearn/semi_supervised/tests/test_label_propagation.py\n+++ b/sklearn/semi_supervised/tests/test_label_propagation.py\n@@ -15,6 +15,9 @@\n     assert_allclose,\n     assert_array_equal,\n )\n+from sklearn.utils._testing import _convert_container\n+\n+CONSTRUCTOR_TYPES = (\"array\", \"sparse_csr\", \"sparse_csc\")\n \n ESTIMATORS = [\n     (label_propagation.LabelPropagation, {\"kernel\": \"rbf\"}),\n@@ -122,9 +125,27 @@ def test_label_propagation_closed_form(global_dtype):\n     assert_allclose(expected, clf.label_distributions_, atol=1e-4)\n \n \n-def test_convergence_speed():\n+@pytest.mark.parametrize(\"accepted_sparse_type\", [\"sparse_csr\", \"sparse_csc\"])\n+@pytest.mark.parametrize(\"index_dtype\", [np.int32, np.int64])\n+@pytest.mark.parametrize(\"dtype\", [np.float32, np.float64])\n+@pytest.mark.parametrize(\"Estimator, parameters\", ESTIMATORS)\n+def test_sparse_input_types(\n+    accepted_sparse_type, index_dtype, dtype, Estimator, parameters\n+):\n+    # This is non-regression test for #17085\n+    X = _convert_container([[1.0, 0.0], [0.0, 2.0], [1.0, 3.0]], accepted_sparse_type)\n+    X.data = X.data.astype(dtype, copy=False)\n+    X.indices = X.indices.astype(index_dtype, copy=False)\n+    X.indptr = X.indptr.astype(index_dtype, copy=False)\n+    labels = [0, 1, -1]\n+    clf = Estimator(**parameters).fit(X, labels)\n+    assert_array_equal(clf.predict([[0.5, 2.5]]), np.array([1]))\n+\n+\n+@pytest.mark.parametrize(\"constructor_type\", CONSTRUCTOR_TYPES)\n+def test_convergence_speed(constructor_type):\n     # This is a non-regression test for #5774\n-    X = np.array([[1.0, 0.0], [0.0, 1.0], [1.0, 2.5]])\n+    X = _convert_container([[1.0, 0.0], [0.0, 1.0], [1.0, 2.5]], constructor_type)\n     y = np.array([0, 1, -1])\n     mdl = label_propagation.LabelSpreading(kernel=\"rbf\", max_iter=5000)\n     mdl.fit(X, y)\n",
  "problem_statement": "LabelPropagation raises TypeError: A sparse matrix was passed\n#### Describe the bug\r\n\r\nLabelPropagation (and LabelSpreading) error out for sparse matrices.\r\n\r\n#### Steps/Code to Reproduce\r\n\r\n```\r\nimport sklearn\r\nfrom scipy.sparse import csr_matrix\r\nfrom sklearn.datasets import make_classification\r\nfrom sklearn.semi_supervised import LabelPropagation\r\n\r\nprint(sklearn.__version__)\r\n\r\nX, y = make_classification()\r\nclassifier = LabelPropagation(kernel='knn')\r\nclassifier.fit(X, y)\r\ny_pred = classifier.predict(X)\r\n\r\nX, y = make_classification()\r\nclassifier = LabelPropagation(kernel='knn')\r\nclassifier.fit(csr_matrix(X), y)\r\ny_pred = classifier.predict(csr_matrix(X))\r\n```\r\n\r\n#### Expected Results\r\n\r\nSparse case should work as does the dense one.\r\n\r\n#### Actual Results\r\n\r\n```\r\n0.22.2.post1\r\nTraceback (most recent call last):\r\n[...]\r\nTypeError: A sparse matrix was passed, but dense data is required. Use X.toarray() to convert to a dense numpy array.\r\n```\r\n\r\n#### Fix\r\n\r\nChanging \r\n\r\n```\r\n        X, y = check_X_y(X, y)\r\n```\r\n\r\nin _label_propagation.py line 224 to \r\n\r\n```\r\n        X, y = check_X_y(X, y, accept_sparse=['csc', 'csr', 'coo', 'dok',\r\n                                              'bsr', 'lil', 'dia'])\r\n```\r\n\r\nseems to fix the problem for me (BTW: a similar check accepting sparse matrices is done in BaseLabelPropagations predict_proba at line 189). This fix also heals LabelSpreading.\r\n\nFIX LabelPropagation handling of sparce matrices #17085\n#### Reference Issues/PRs\r\n\r\nFixes #17085\r\n\r\n#### What does this implement/fix? Explain your changes.\r\n\r\nLabel propagation and spreading allow to classify using sparse data according to documentation. Tests only covered the dense case. Newly added coverage for sparse matrices allows to reproduce the problem in #17085. The proposed fix in #17085 works for the extended tests.\r\n\r\n#### Any other comments?\r\n\r\n- Supporting scipy's dok_matrix produces the UserWarning \"Can't check dok sparse matrix for nan or inf.\". So this format seems to be unsuitable?\r\n- `test_label_propagation_closed_form` fails for sparse matrices \r\n\n",
  "hints_text": "Just checked: the fix seems to work for kernel='rbf', too.\nHi, I would like to take over since this is stalled.\nHi @cozek , sure go ahead: FYI you can comment \"take\" in this issue and it will automatically assigned to you.\n",
  "created_at": "2021-03-11T17:53:04Z",
  "version": "1.3",
  "FAIL_TO_PASS": "[\"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters0-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters1-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelPropagation-parameters2-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters3-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters4-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float32-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float32-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float32-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float32-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float64-int32-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float64-int32-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float64-int64-sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_sparse_input_types[LabelSpreading-parameters5-float64-int64-sparse_csc]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_convergence_speed[sparse_csr]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_convergence_speed[sparse_csc]\"]",
  "PASS_TO_PASS": "[\"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelPropagation-parameters0]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelPropagation-parameters1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelPropagation-parameters2]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelSpreading-parameters3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelSpreading-parameters4]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_fit_transduction[float64-LabelSpreading-parameters5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_distribution[float64-LabelPropagation-parameters0]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_distribution[float64-LabelPropagation-parameters2]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_distribution[float64-LabelSpreading-parameters3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_distribution[float64-LabelSpreading-parameters5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelPropagation-parameters0]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelPropagation-parameters1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelPropagation-parameters2]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelSpreading-parameters3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelSpreading-parameters4]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict[float64-LabelSpreading-parameters5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelPropagation-parameters0]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelPropagation-parameters1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelPropagation-parameters2]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelSpreading-parameters3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelSpreading-parameters4]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_proba[float64-LabelSpreading-parameters5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters0-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters0-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters0-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters0-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters0-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters1-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters1-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters1-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters1-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters1-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters2-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters2-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters2-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters2-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelPropagation-parameters2-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters3-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters3-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters3-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters3-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters3-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters4-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters4-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters4-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters4-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters4-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters5-0.1]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters5-0.3]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters5-0.5]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters5-0.7]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_spreading_closed_form[float64-LabelSpreading-parameters5-0.9]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_propagation_closed_form[float64]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_convergence_speed[array]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_convergence_warning\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_propagation_non_zero_normalizer[LabelSpreading]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_label_propagation_non_zero_normalizer[LabelPropagation]\", \"sklearn/semi_supervised/tests/test_label_propagation.py::test_predict_sparse_callable_kernel[float64]\"]",
  "environment_setup_commit": "1e8a5b833d1b58f3ab84099c4582239af854b23a",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:31.014248",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}