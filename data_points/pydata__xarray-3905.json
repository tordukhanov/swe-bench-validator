{
  "repo": "pydata/xarray",
  "instance_id": "pydata__xarray-3905",
  "base_commit": "fb5fe79a2881055065cc2c0ed3f49f5448afdf32",
  "patch": "diff --git a/xarray/core/formatting.py b/xarray/core/formatting.py\n--- a/xarray/core/formatting.py\n+++ b/xarray/core/formatting.py\n@@ -3,7 +3,7 @@\n import contextlib\n import functools\n from datetime import datetime, timedelta\n-from itertools import zip_longest\n+from itertools import chain, zip_longest\n from typing import Hashable\n \n import numpy as np\n@@ -422,6 +422,17 @@ def set_numpy_options(*args, **kwargs):\n         np.set_printoptions(**original)\n \n \n+def limit_lines(string: str, *, limit: int):\n+    \"\"\"\n+    If the string is more lines than the limit,\n+    this returns the middle lines replaced by an ellipsis\n+    \"\"\"\n+    lines = string.splitlines()\n+    if len(lines) > limit:\n+        string = \"\\n\".join(chain(lines[: limit // 2], [\"...\"], lines[-limit // 2 :]))\n+    return string\n+\n+\n def short_numpy_repr(array):\n     array = np.asarray(array)\n \n@@ -447,7 +458,7 @@ def short_data_repr(array):\n     elif hasattr(internal_data, \"__array_function__\") or isinstance(\n         internal_data, dask_array_type\n     ):\n-        return repr(array.data)\n+        return limit_lines(repr(array.data), limit=40)\n     elif array._in_memory or array.size < 1e5:\n         return short_numpy_repr(array)\n     else:\n",
  "test_patch": "diff --git a/xarray/tests/test_formatting.py b/xarray/tests/test_formatting.py\n--- a/xarray/tests/test_formatting.py\n+++ b/xarray/tests/test_formatting.py\n@@ -405,10 +405,19 @@ def test_short_numpy_repr():\n         np.random.randn(20, 20),\n         np.random.randn(5, 10, 15),\n         np.random.randn(5, 10, 15, 3),\n+        np.random.randn(100, 5, 1),\n     ]\n     # number of lines:\n-    # for default numpy repr: 167, 140, 254, 248\n-    # for short_numpy_repr: 1, 7, 24, 19\n+    # for default numpy repr: 167, 140, 254, 248, 599\n+    # for short_numpy_repr: 1, 7, 24, 19, 25\n     for array in cases:\n         num_lines = formatting.short_numpy_repr(array).count(\"\\n\") + 1\n         assert num_lines < 30\n+\n+\n+def test_large_array_repr_length():\n+\n+    da = xr.DataArray(np.random.randn(100, 5, 1))\n+\n+    result = repr(da).splitlines()\n+    assert len(result) < 50\n",
  "problem_statement": "Truncate array repr based on line count\n#### MCVE Code Sample\r\n<!-- In order for the maintainers to efficiently understand and prioritize issues, we ask you post a \"Minimal, Complete and Verifiable Example\" (MCVE): http://matthewrocklin.com/blog/work/2018/02/28/minimal-bug-reports -->\r\n\r\nI thought we might have had an issue (and maybe solved it?) but couldn't find it anywhere. Forgive me if I'm duplicating.\r\n\r\n```python\r\nxr.DataArray(np.random.rand(100,5,1))\r\n\r\n<xarray.DataArray (dim_0: 100, dim_1: 5, dim_2: 1)>\r\narray([[[0.71333665],\r\n        [0.93820892],\r\n        [0.48678056],\r\n        [0.07299961],\r\n        [0.63542414]],\r\n\r\n*** Deleted 400 lines ***\r\n\r\n       [[0.29987457],\r\n        [0.55963998],\r\n        [0.25976744],\r\n        [0.80062955],\r\n        [0.503025  ]],\r\n\r\n       [[0.48255097],\r\n        [0.55861315],\r\n        [0.36059861],\r\n        [0.96539665],\r\n        [0.05674621]],\r\n\r\n       [[0.81389941],\r\n        [0.55745028],\r\n        [0.20348983],\r\n        [0.63390148],\r\n        [0.94698865]],\r\n\r\n       [[0.16792246],\r\n        [0.9252646 ],\r\n        [0.38596734],\r\n        [0.17168077],\r\n        [0.18162088]],\r\n\r\n       [[0.04526339],\r\n        [0.70028912],\r\n        [0.72388995],\r\n        [0.97481276],\r\n        [0.66155381]],\r\n\r\n       [[0.15058745],\r\n        [0.57646963],\r\n        [0.53382085],\r\n        [0.24696459],\r\n        [0.77601528]],\r\n\r\n       [[0.6752243 ],\r\n        [0.84991466],\r\n        [0.87758404],\r\n        [0.70828751],\r\n        [0.04033709]]])\r\nDimensions without coordinates: dim_0, dim_1, dim_2\r\n```\r\n\r\n#### Expected Output\r\n\r\nWith _larger_ arrays, it's much more reasonable:\r\n\r\n```\r\n<xarray.DataArray (dim_0: 500, dim_1: 6, dim_2: 1)>\r\narray([[[0.9680447 ],\r\n        [0.12554914],\r\n        [0.9163406 ],\r\n        [0.63710986],\r\n        [0.97778361],\r\n        [0.6419909 ]],\r\n\r\n       [[0.48480678],\r\n        [0.31214637],\r\n        [0.72270997],\r\n        [0.81523543],\r\n        [0.34327902],\r\n        [0.80941523]],\r\n\r\n       [[0.92192284],\r\n        [0.47841933],\r\n        [0.00760903],\r\n        [0.83886152],\r\n        [0.88538772],\r\n        [0.6532889 ]],\r\n\r\n       ...,\r\n\r\n       [[0.39558324],\r\n        [0.42220218],\r\n        [0.56731915],\r\n        [0.27388751],\r\n        [0.51097741],\r\n        [0.62824705]],\r\n\r\n       [[0.97379019],\r\n        [0.0311196 ],\r\n        [0.09790975],\r\n        [0.65206508],\r\n        [0.14369363],\r\n        [0.09683937]],\r\n\r\n       [[0.71318171],\r\n        [0.88591664],\r\n        [0.30032286],\r\n        [0.97324135],\r\n        [0.10250702],\r\n        [0.03973667]]])\r\nDimensions without coordinates: dim_0, dim_1, dim_2\r\n```\r\n\r\n#### Problem Description\r\n<!-- this should explain why the current behavior is a problem and why the expected output is a better solution -->\r\n\r\nSomething like 40 lines is probably a reasonable place to truncate?\r\n\r\n#### Output of ``xr.show_versions()``\r\n<details>\r\n# Paste the output here xr.show_versions() here\r\nINSTALLED VERSIONS\r\n------------------\r\ncommit: None\r\npython: 3.7.3 | packaged by conda-forge | (default, Jul  1 2019, 21:52:21) \r\n[GCC 7.3.0]\r\npython-bits: 64\r\nOS: Linux\r\nOS-release: [...]\r\nmachine: x86_64\r\nprocessor: x86_64\r\nbyteorder: little\r\nLC_ALL: None\r\nLANG: en_US.utf8\r\nLOCALE: en_US.UTF-8\r\nlibhdf5: 1.10.5\r\nlibnetcdf: 4.7.1\r\n\r\nxarray: 0.15.0\r\npandas: 0.25.3\r\nnumpy: 1.17.3\r\nscipy: 1.3.2\r\nnetCDF4: 1.5.3\r\npydap: None\r\nh5netcdf: 0.7.4\r\nh5py: 2.10.0\r\nNio: None\r\nzarr: None\r\ncftime: 1.0.4.2\r\nnc_time_axis: None\r\nPseudoNetCDF: None\r\nrasterio: None\r\ncfgrib: None\r\niris: None\r\nbottleneck: 1.2.1\r\ndask: 2.7.0\r\ndistributed: 2.7.0\r\nmatplotlib: 3.1.2\r\ncartopy: None\r\nseaborn: 0.9.0\r\nnumbagg: None\r\nsetuptools: 41.6.0.post20191101\r\npip: 19.3.1\r\nconda: None\r\npytest: 5.2.2\r\nIPython: 7.9.0\r\nsphinx: 2.2.1\r\n</details>\r\n\n",
  "hints_text": "Hmm, that does look pretty bad. We do have some existing heuristics for shortening up NumPyâ€™s repr but perhaps they could use some tweaking:\r\nhttps://github.com/pydata/xarray/blob/master/xarray/core/formatting.py#L416",
  "created_at": "2020-03-27T20:45:08Z",
  "version": "0.12",
  "FAIL_TO_PASS": "[\"xarray/tests/test_formatting.py::test_large_array_repr_length\"]",
  "PASS_TO_PASS": "[\"xarray/tests/test_formatting.py::TestFormatting::test_get_indexer_at_least_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_first_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_last_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_last_item\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_item\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_array_flat\", \"xarray/tests/test_formatting.py::TestFormatting::test_pretty_print\", \"xarray/tests/test_formatting.py::TestFormatting::test_maybe_truncate\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_timestamp_out_of_bounds\", \"xarray/tests/test_formatting.py::TestFormatting::test_attribute_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_array_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_attrs_repr_with_array\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_dataset_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_array_repr\", \"xarray/tests/test_formatting.py::test_set_numpy_options\", \"xarray/tests/test_formatting.py::test_short_numpy_repr\"]",
  "environment_setup_commit": "1c198a191127c601d091213c4b3292a8bb3054e1",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.874450",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}