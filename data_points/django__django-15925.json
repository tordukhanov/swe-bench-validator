{
  "repo": "django/django",
  "instance_id": "django__django-15925",
  "base_commit": "fd93db97c7228b16a4f92f97ef05b0d72418d952",
  "patch": "diff --git a/django/db/backends/sqlite3/schema.py b/django/db/backends/sqlite3/schema.py\n--- a/django/db/backends/sqlite3/schema.py\n+++ b/django/db/backends/sqlite3/schema.py\n@@ -408,10 +408,11 @@ def remove_field(self, model, field):\n             # For explicit \"through\" M2M fields, do nothing\n         elif (\n             self.connection.features.can_alter_table_drop_column\n-            # Primary keys, unique fields, and foreign keys are not\n-            # supported in ALTER TABLE DROP COLUMN.\n+            # Primary keys, unique fields, indexed fields, and foreign keys are\n+            # not supported in ALTER TABLE DROP COLUMN.\n             and not field.primary_key\n             and not field.unique\n+            and not field.db_index\n             and not (field.remote_field and field.db_constraint)\n         ):\n             super().remove_field(model, field)\n",
  "test_patch": "diff --git a/tests/schema/tests.py b/tests/schema/tests.py\n--- a/tests/schema/tests.py\n+++ b/tests/schema/tests.py\n@@ -813,6 +813,17 @@ def test_remove_field(self):\n                 False,\n             )\n \n+    def test_remove_indexed_field(self):\n+        with connection.schema_editor() as editor:\n+            editor.create_model(AuthorCharFieldWithIndex)\n+        with connection.schema_editor() as editor:\n+            editor.remove_field(\n+                AuthorCharFieldWithIndex,\n+                AuthorCharFieldWithIndex._meta.get_field(\"char_field\"),\n+            )\n+        columns = self.column_classes(AuthorCharFieldWithIndex)\n+        self.assertNotIn(\"char_field\", columns)\n+\n     def test_alter(self):\n         \"\"\"\n         Tests simple altering of fields\n",
  "problem_statement": "RemoveField on indexed fields crashes on SQLite 3.35.5+\nDescription\n\t \n\t\t(last modified by cessor)\n\t \nDescription\nI encountered the following error with django 4.1 in my Gitlab CI/CD Pipeline. When I bumped django versions from 4.0.7 to 4.1. my pipeline broke during the testing stage; specifically during db migrations. I have not changed any other source code. \nSteps to reproduce\nMinimal example attached. Run make green to see that it works with 4.0.7, run make red to see that it does not work with 4.1. It will build and exercise a docker container which installs all dependencies in isolation and sets up an example django app and run migrations. \nManual steps: \nInstall django 4.1\nCreate a new project\nCreate an app\nInstall app in project\nCreate a model\nAdd field on model, set db_index=True\nMake migrations: $ python manage.py makemigrations\nRemove field from model\nMake migrations: $ python manage.py makemigrations\nApply migrations: $ python manage.py migrate\nThe migration fails with the following error (for an app called web, with a model called Entity with a field called attribute for example):\nRunning migrations:\nApplying contenttypes.0001_initial... OK\n...\nApplying sessions.0001_initial... OK\nApplying web.0001_initial... OK\nApplying web.0002_remove_entity_attribute...Traceback (most recent call last):\nFile \"/usr/local/lib/python3.10/site-packages/django/db/backends/utils.py\", line 89, in _execute\n return self.cursor.execute(sql, params)\nFile \"/usr/local/lib/python3.10/site-packages/django/db/backends/sqlite3/base.py\", line 357, in execute\n return Database.Cursor.execute(self, query, params)\nsqlite3.OperationalError: error in index web_entity_attribute_d22c3fcb after drop column: no such column: attribute\nDetails\nThe above steps create a set of migrations where at the end a RemoveField migration is produced. Applying this migration fails for fields which had db_index=True. The example I attached uses a SlugField where db_index defaults to True, setting this parameter to False will apply the migration without this error. \nI reproduced the error with the following field types: TextField, IntegerField, SlugField, CharField, URLField\n",
  "hints_text": "Minimal Example\nI'm really puzzled. I cannot reproduce this issue manually, but make red crashes.\nReplying to Mariusz Felisiak: I'm really puzzled. I cannot reproduce this issue manually, but make red crashes. Thank you for giving this a try. I investigated this some further and realized that my manual description is not precise enough to reproduce the error. The example I attached uses a SlugField, but the error does not occur with other field types, such as CharFields. I noticed that SlugFields set db_index=True by default (See Link 1), and could reproduce the bug with other fields when setting db_index=True. I will change the bug description accordingly. Links: 1: SlugField: ​https://github.com/django/django/blob/main/django/db/models/fields/__init__.py#L2301\nRegression test of the bug reported\nThe issue is valid. I have written the regression test of the exact test case. And found the first bad commit as below: 3702819227fd0cdd9b581cd99e11d1561d51cbeb is the first bad commit commit 3702819227fd0cdd9b581cd99e11d1561d51cbeb Author: Mariusz Felisiak <felisiak.mariusz@gmail.com> Date: Fri Feb 11 22:21:58 2022 +0100 Refs #32502 -- Avoided table rebuild when removing fields on SQLite 3.35.5+. ALTER TABLE ... DROP COLUMN was introduced in SQLite 3.35+ however a data corruption issue was fixed in SQLite 3.35.5. django/db/backends/sqlite3/features.py | 2 ++ django/db/backends/sqlite3/schema.py | 10 ++++++++++ tests/schema/tests.py | 18 ++++++++++++++++++ 3 files changed, 30 insertions(+) bisect found first bad commit\nThanks! It should be enough to avoid this optimization on indexes fields: django/db/backends/sqlite3/schema.py diff --git a/django/db/backends/sqlite3/schema.py b/django/db/backends/sqlite3/schema.py index 55fdf5fbfe..6c106ae868 100644 a b class DatabaseSchemaEditor(BaseDatabaseSchemaEditor): 408408 # For explicit \"through\" M2M fields, do nothing 409409 elif ( 410410 self.connection.features.can_alter_table_drop_column 411 # Primary keys, unique fields, and foreign keys are not 412 # supported in ALTER TABLE DROP COLUMN. 411 # Primary keys, unique fields, indexed fields, and foreign keys are 412 # not supported in ALTER TABLE DROP COLUMN. 413413 and not field.primary_key 414414 and not field.unique 415 and not field.db_index 415416 and not (field.remote_field and field.db_constraint) 416417 ): 417418 super().remove_field(model, field) According to ​SQLite docs: Possible reasons why the DROP COLUMN command can fail include':' ... The column is indexed. Regression in 3702819227fd0cdd9b581cd99e11d1561d51cbeb.",
  "created_at": "2022-08-06T13:47:53Z",
  "version": "4.2",
  "FAIL_TO_PASS": "[\"test_remove_indexed_field (schema.tests.SchemaTests)\"]",
  "PASS_TO_PASS": "[\"effective_default() should be used for DateField, DateTimeField, and\", \"Tests adding fields to models\", \"Tests binary fields get a sane default (#22851)\", \"test_add_field_db_collation (schema.tests.SchemaTests)\", \"test_add_field_default_dropped (schema.tests.SchemaTests)\", \"test_add_field_default_nullable (schema.tests.SchemaTests)\", \"Tests adding fields to models with a default that is not directly\", \"test_add_field_durationfield_with_default (schema.tests.SchemaTests)\", \"test_add_field_o2o_nullable (schema.tests.SchemaTests)\", \"Adding a field and removing it removes all deferred sql referring to it.\", \"Tests adding fields to models with a temporary default\", \"Tests adding fields to models with a temporary default where\", \"#23987 - effective_default() should be used as the field default when\", \"Regression test for #23009.\", \"test_add_foreign_key_quoted_db_table (schema.tests.SchemaTests)\", \"test_add_foreign_object (schema.tests.SchemaTests)\", \"Tests index addition and removal\", \"test_add_textfield_default_nullable (schema.tests.SchemaTests)\", \"test_add_textfield_unhashable_default (schema.tests.SchemaTests)\", \"Tests simple altering of fields\", \"test_alter_auto_field_quoted_db_column (schema.tests.SchemaTests)\", \"test_alter_auto_field_to_char_field (schema.tests.SchemaTests)\", \"test_alter_auto_field_to_integer_field (schema.tests.SchemaTests)\", \"test_alter_autofield_pk_to_bigautofield_pk (schema.tests.SchemaTests)\", \"test_alter_autofield_pk_to_smallautofield_pk (schema.tests.SchemaTests)\", \"#24307 - Should skip an alter statement on databases with\", \"test_alter_db_table_case (schema.tests.SchemaTests)\", \"test_alter_field_add_index_to_integerfield (schema.tests.SchemaTests)\", \"test_alter_field_choices_noop (schema.tests.SchemaTests)\", \"test_alter_field_db_collation (schema.tests.SchemaTests)\", \"test_alter_field_default_dropped (schema.tests.SchemaTests)\", \"No queries are performed when changing field attributes that don't\", \"test_alter_field_fk_keeps_index (schema.tests.SchemaTests)\", \"test_alter_field_fk_to_o2o (schema.tests.SchemaTests)\", \"test_alter_field_o2o_keeps_unique (schema.tests.SchemaTests)\", \"test_alter_field_o2o_to_fk (schema.tests.SchemaTests)\", \"test_alter_field_type_and_db_collation (schema.tests.SchemaTests)\", \"Tests altering of FKs\", \"#25492 - Altering a foreign key's structure and data in the same\", \"#24163 - Tests altering of ForeignKey to OneToOneField\", \"Should be able to convert an implicit \\\"id\\\" field to an explicit \\\"id\\\"\", \"Should be able to rename an IntegerField(primary_key=True) to\", \"test_alter_not_unique_field_to_primary_key (schema.tests.SchemaTests)\", \"#23609 - Tests handling of default values when altering from NULL to NOT NULL.\", \"#23738 - Can change a nullable field with default to non-nullable\", \"test_alter_null_with_default_value_deferred_constraints (schema.tests.SchemaTests)\", \"Changing a field type shouldn't affect the not null status.\", \"#24163 - Tests altering of OneToOneField to ForeignKey\", \"Changing the primary key field name of a model with a self-referential\", \"test_alter_primary_key_db_collation (schema.tests.SchemaTests)\", \"test_alter_primary_key_quoted_db_table (schema.tests.SchemaTests)\", \"test_alter_primary_key_the_same_name (schema.tests.SchemaTests)\", \"Should be able to rename an SmallIntegerField(primary_key=True) to\", \"test_alter_text_field (schema.tests.SchemaTests)\", \"#25002 - Test conversion of text field to date field.\", \"#25002 - Test conversion of text field to datetime field.\", \"test_alter_text_field_to_not_null_with_default_value (schema.tests.SchemaTests)\", \"#25002 - Test conversion of text field to time field.\", \"#24447 - Tests adding a FK constraint for an existing column\", \"test_char_field_pk_to_auto_field (schema.tests.SchemaTests)\", \"test_char_field_with_db_index_to_fk (schema.tests.SchemaTests)\", \"test_check_constraint_timedelta_param (schema.tests.SchemaTests)\", \"Tests creating/deleting CHECK constraints\", \"test_ci_cs_db_collation (schema.tests.SchemaTests)\", \"test_composite_func_index (schema.tests.SchemaTests)\", \"test_composite_func_index_field_and_expression (schema.tests.SchemaTests)\", \"test_composite_func_unique_constraint (schema.tests.SchemaTests)\", \"Ensures transaction is correctly closed when an error occurs\", \"Tests creating models with index_together already defined\", \"Tries creating a model's table, and then deleting it.\", \"Tries creating a model's table, and then deleting it when it has a\", \"test_db_collation_charfield (schema.tests.SchemaTests)\", \"test_db_collation_textfield (schema.tests.SchemaTests)\", \"Tests renaming of the table\", \"Creating tables out of FK order, then repointing, works\", \"The db_constraint parameter is respected\", \"Creating a FK to a proxy model creates database constraints.\", \"Regression test for #21497.\", \"test_func_index (schema.tests.SchemaTests)\", \"test_func_index_calc (schema.tests.SchemaTests)\", \"test_func_index_cast (schema.tests.SchemaTests)\", \"test_func_index_collate (schema.tests.SchemaTests)\", \"test_func_index_collate_f_ordered (schema.tests.SchemaTests)\", \"test_func_index_f (schema.tests.SchemaTests)\", \"test_func_index_f_decimalfield (schema.tests.SchemaTests)\", \"test_func_index_invalid_topmost_expressions (schema.tests.SchemaTests)\", \"test_func_index_json_key_transform (schema.tests.SchemaTests)\", \"test_func_index_json_key_transform_cast (schema.tests.SchemaTests)\", \"test_func_index_lookups (schema.tests.SchemaTests)\", \"test_func_index_multiple_wrapper_references (schema.tests.SchemaTests)\", \"test_func_index_nondeterministic (schema.tests.SchemaTests)\", \"test_func_index_nonexistent_field (schema.tests.SchemaTests)\", \"test_func_unique_constraint (schema.tests.SchemaTests)\", \"test_func_unique_constraint_collate (schema.tests.SchemaTests)\", \"test_func_unique_constraint_lookups (schema.tests.SchemaTests)\", \"test_func_unique_constraint_nondeterministic (schema.tests.SchemaTests)\", \"test_func_unique_constraint_nonexistent_field (schema.tests.SchemaTests)\", \"test_func_unique_constraint_partial (schema.tests.SchemaTests)\", \"Tests removing and adding index_together constraints on a model.\", \"Tests removing and adding index_together constraints that include\", \"Tests creation/altering of indexes\", \"test_m2m (schema.tests.SchemaTests)\", \"test_m2m_create (schema.tests.SchemaTests)\", \"test_m2m_create_custom (schema.tests.SchemaTests)\", \"test_m2m_create_inherited (schema.tests.SchemaTests)\", \"test_m2m_create_through (schema.tests.SchemaTests)\", \"test_m2m_create_through_custom (schema.tests.SchemaTests)\", \"test_m2m_create_through_inherited (schema.tests.SchemaTests)\", \"test_m2m_custom (schema.tests.SchemaTests)\", \"test_m2m_db_constraint (schema.tests.SchemaTests)\", \"test_m2m_db_constraint_custom (schema.tests.SchemaTests)\", \"test_m2m_db_constraint_inherited (schema.tests.SchemaTests)\", \"test_m2m_inherited (schema.tests.SchemaTests)\", \"test_m2m_rename_field_in_target_model (schema.tests.SchemaTests)\", \"test_m2m_repoint (schema.tests.SchemaTests)\", \"test_m2m_repoint_custom (schema.tests.SchemaTests)\", \"test_m2m_repoint_inherited (schema.tests.SchemaTests)\", \"test_m2m_through_alter (schema.tests.SchemaTests)\", \"test_m2m_through_alter_custom (schema.tests.SchemaTests)\", \"test_m2m_through_alter_inherited (schema.tests.SchemaTests)\", \"test_m2m_through_remove (schema.tests.SchemaTests)\", \"Table names are stripped of their namespace/schema before being used to\", \"When a primary key that's pointed to by a ForeignKey with\", \"Indexes defined with ordering (ASC/DESC) defined on column\", \"Tests altering of the primary key\", \"Foreign keys without database level constraint don't prevent the field\", \"Foreign keys without database level constraint don't prevent the table\", \"#23065 - Constraint names must be quoted if they contain capital letters.\", \"Changing db_index to False doesn't remove indexes from Meta.indexes.\", \"test_remove_field (schema.tests.SchemaTests)\", \"test_remove_field_check_does_not_remove_meta_constraints (schema.tests.SchemaTests)\", \"test_remove_field_unique_does_not_remove_meta_constraints (schema.tests.SchemaTests)\", \"test_remove_index_together_does_not_remove_meta_indexes (schema.tests.SchemaTests)\", \"test_remove_unique_together_does_not_remove_meta_constraints (schema.tests.SchemaTests)\", \"Renaming a field shouldn't affect the not null status.\", \"test_rename_referenced_field (schema.tests.SchemaTests)\", \"test_rename_table_renames_deferred_sql_references (schema.tests.SchemaTests)\", \"test_text_field_with_db_index (schema.tests.SchemaTests)\", \"test_text_field_with_db_index_to_fk (schema.tests.SchemaTests)\", \"Tests removing and adding unique constraints to a single column.\", \"test_unique_constraint (schema.tests.SchemaTests)\", \"test_unique_constraint_field_and_expression (schema.tests.SchemaTests)\", \"test_unique_name_quoting (schema.tests.SchemaTests)\", \"Tests removing and adding unique_together constraints on a model.\", \"Tests removing and adding unique_together constraints that include\"]",
  "environment_setup_commit": "0fbdb9784da915fce5dcc1fe82bac9b4785749e5",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.743012",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}