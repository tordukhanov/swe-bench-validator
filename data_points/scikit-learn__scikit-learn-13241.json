{
  "repo": "scikit-learn/scikit-learn",
  "instance_id": "scikit-learn__scikit-learn-13241",
  "base_commit": "f8b108d0c6f2f82b2dc4e32a6793f9d9ac9cf2f4",
  "patch": "diff --git a/sklearn/decomposition/kernel_pca.py b/sklearn/decomposition/kernel_pca.py\n--- a/sklearn/decomposition/kernel_pca.py\n+++ b/sklearn/decomposition/kernel_pca.py\n@@ -8,6 +8,7 @@\n from scipy.sparse.linalg import eigsh\n \n from ..utils import check_random_state\n+from ..utils.extmath import svd_flip\n from ..utils.validation import check_is_fitted, check_array\n from ..exceptions import NotFittedError\n from ..base import BaseEstimator, TransformerMixin, _UnstableOn32BitMixin\n@@ -210,6 +211,10 @@ def _fit_transform(self, K):\n                                                 maxiter=self.max_iter,\n                                                 v0=v0)\n \n+        # flip eigenvectors' sign to enforce deterministic output\n+        self.alphas_, _ = svd_flip(self.alphas_,\n+                                   np.empty_like(self.alphas_).T)\n+\n         # sort eigenvectors in descending order\n         indices = self.lambdas_.argsort()[::-1]\n         self.lambdas_ = self.lambdas_[indices]\n",
  "test_patch": "diff --git a/sklearn/decomposition/tests/test_kernel_pca.py b/sklearn/decomposition/tests/test_kernel_pca.py\n--- a/sklearn/decomposition/tests/test_kernel_pca.py\n+++ b/sklearn/decomposition/tests/test_kernel_pca.py\n@@ -4,7 +4,7 @@\n \n from sklearn.utils.testing import (assert_array_almost_equal, assert_less,\n                                    assert_equal, assert_not_equal,\n-                                   assert_raises)\n+                                   assert_raises, assert_allclose)\n \n from sklearn.decomposition import PCA, KernelPCA\n from sklearn.datasets import make_circles\n@@ -71,6 +71,21 @@ def test_kernel_pca_consistent_transform():\n     assert_array_almost_equal(transformed1, transformed2)\n \n \n+def test_kernel_pca_deterministic_output():\n+    rng = np.random.RandomState(0)\n+    X = rng.rand(10, 10)\n+    eigen_solver = ('arpack', 'dense')\n+\n+    for solver in eigen_solver:\n+        transformed_X = np.zeros((20, 2))\n+        for i in range(20):\n+            kpca = KernelPCA(n_components=2, eigen_solver=solver,\n+                             random_state=rng)\n+            transformed_X[i, :] = kpca.fit_transform(X)[0]\n+        assert_allclose(\n+            transformed_X, np.tile(transformed_X[0, :], 20).reshape(20, 2))\n+\n+\n def test_kernel_pca_sparse():\n     rng = np.random.RandomState(0)\n     X_fit = sp.csr_matrix(rng.random_sample((5, 4)))\ndiff --git a/sklearn/decomposition/tests/test_pca.py b/sklearn/decomposition/tests/test_pca.py\n--- a/sklearn/decomposition/tests/test_pca.py\n+++ b/sklearn/decomposition/tests/test_pca.py\n@@ -6,6 +6,7 @@\n \n from sklearn.utils.testing import assert_almost_equal\n from sklearn.utils.testing import assert_array_almost_equal\n+from sklearn.utils.testing import assert_allclose\n from sklearn.utils.testing import assert_equal\n from sklearn.utils.testing import assert_greater\n from sklearn.utils.testing import assert_raise_message\n@@ -703,6 +704,19 @@ def test_pca_dtype_preservation(svd_solver):\n     check_pca_int_dtype_upcast_to_double(svd_solver)\n \n \n+def test_pca_deterministic_output():\n+    rng = np.random.RandomState(0)\n+    X = rng.rand(10, 10)\n+\n+    for solver in solver_list:\n+        transformed_X = np.zeros((20, 2))\n+        for i in range(20):\n+            pca = PCA(n_components=2, svd_solver=solver, random_state=rng)\n+            transformed_X[i, :] = pca.fit_transform(X)[0]\n+        assert_allclose(\n+            transformed_X, np.tile(transformed_X[0, :], 20).reshape(20, 2))\n+\n+\n def check_pca_float_dtype_preservation(svd_solver):\n     # Ensure that PCA does not upscale the dtype when input is float32\n     X_64 = np.random.RandomState(0).rand(1000, 4).astype(np.float64)\n",
  "problem_statement": "Differences among the results of KernelPCA with rbf kernel\nHi there,\r\nI met with a problem:\r\n\r\n#### Description\r\nWhen I run KernelPCA for dimension reduction for the same datasets, the results are different in signs.\r\n\r\n#### Steps/Code to Reproduce\r\nJust to reduce the dimension to 7 with rbf kernel:\r\npca = KernelPCA(n_components=7, kernel='rbf', copy_X=False, n_jobs=-1)\r\npca.fit_transform(X)\r\n\r\n#### Expected Results\r\nThe same result.\r\n\r\n#### Actual Results\r\nThe results are the same except for their signs:(\r\n[[-0.44457617 -0.18155886 -0.10873474  0.13548386 -0.1437174  -0.057469\t0.18124364]] \r\n\r\n[[ 0.44457617  0.18155886  0.10873474 -0.13548386 -0.1437174  -0.057469 -0.18124364]] \r\n\r\n[[-0.44457617 -0.18155886  0.10873474  0.13548386  0.1437174   0.057469  0.18124364]] \r\n\r\n#### Versions\r\n0.18.1\r\n\n",
  "hints_text": "Looks like this sign flip thing was already noticed as part of https://github.com/scikit-learn/scikit-learn/issues/5970.\r\n\r\nUsing `sklearn.utils.svd_flip` may be the fix to have a deterministic sign.\r\n\r\nCan you provide a stand-alone snippet to reproduce the problem ? Please read https://stackoverflow.com/help/mcve. Stand-alone means I can copy and paste it in an IPython session. In your case you have not defined `X` for example.\r\n\r\nAlso Readability counts, a lot! Please use triple back-quotes aka [fenced code blocks](https://help.github.com/articles/creating-and-highlighting-code-blocks/) to format error messages code snippets. Bonus points if you use [syntax highlighting](https://help.github.com/articles/creating-and-highlighting-code-blocks/#syntax-highlighting) with `py` for python snippets and `pytb` for tracebacks.\nHi there,\r\n\r\nThanks for your reply! The code file is attached.\r\n\r\n[test.txt](https://github.com/scikit-learn/scikit-learn/files/963545/test.txt)\r\n\r\nI am afraid that the data part is too big, but small training data cannot give the phenomenon. \r\nYou can directly scroll down to the bottom of the code.\r\nBy the way, how sklearn.utils.svd_flip is used? Would you please give me some example by modifying\r\nthe code?\r\n\r\nThe result shows that\r\n```python\r\n# 1st run\r\n[[-0.16466689  0.28032182  0.21064738 -0.12904448 -0.10446288  0.12841524\r\n  -0.05226416]\r\n [-0.16467236  0.28033373  0.21066657 -0.12906051 -0.10448316  0.12844286\r\n  -0.05227781]\r\n [-0.16461369  0.28020562  0.21045685 -0.12888338 -0.10425372  0.12812801\r\n  -0.05211955]\r\n [-0.16455855  0.28008524  0.21025987 -0.12871706 -0.1040384   0.12783259\r\n  -0.05197112]\r\n [-0.16448037  0.27991459  0.20998079 -0.12848151 -0.10373377  0.12741476\r\n  -0.05176132]\r\n [-0.15890147  0.2676744   0.18938366 -0.11071689 -0.07950844  0.09357383\r\n  -0.03398456]\r\n [-0.16447559  0.27990414  0.20996368 -0.12846706 -0.10371504  0.12738904\r\n  -0.05174839]\r\n [-0.16452601  0.2800142   0.21014363 -0.12861891 -0.10391136  0.12765828\r\n  -0.05188354]\r\n [-0.16462521  0.28023075  0.21049772 -0.12891774 -0.10429779  0.12818829\r\n  -0.05214964]\r\n [-0.16471191  0.28042     0.21080727 -0.12917904 -0.10463582  0.12865199\r\n  -0.05238251]]\r\n\r\n# 2nd run\r\n[[-0.16466689  0.28032182  0.21064738  0.12904448 -0.10446288  0.12841524\r\n   0.05226416]\r\n [-0.16467236  0.28033373  0.21066657  0.12906051 -0.10448316  0.12844286\r\n   0.05227781]\r\n [-0.16461369  0.28020562  0.21045685  0.12888338 -0.10425372  0.12812801\r\n   0.05211955]\r\n [-0.16455855  0.28008524  0.21025987  0.12871706 -0.1040384   0.12783259\r\n   0.05197112]\r\n [-0.16448037  0.27991459  0.20998079  0.12848151 -0.10373377  0.12741476\r\n   0.05176132]\r\n [-0.15890147  0.2676744   0.18938366  0.11071689 -0.07950844  0.09357383\r\n   0.03398456]\r\n [-0.16447559  0.27990414  0.20996368  0.12846706 -0.10371504  0.12738904\r\n   0.05174839]\r\n [-0.16452601  0.2800142   0.21014363  0.12861891 -0.10391136  0.12765828\r\n   0.05188354]\r\n [-0.16462521  0.28023075  0.21049772  0.12891774 -0.10429779  0.12818829\r\n   0.05214964]\r\n [-0.16471191  0.28042     0.21080727  0.12917904 -0.10463582  0.12865199\r\n   0.05238251]]\r\n```\r\nin which the sign flips can be easily seen.\nThanks for your stand-alone snippet, for next time remember that such a snippet is key to get good feedback.\r\n\r\nHere is a simplified version showing the problem. This seems to happen only with the `arpack` eigen_solver when `random_state` is not set:\r\n\r\n```py\r\nimport numpy as np\r\nfrom sklearn.decomposition import KernelPCA\r\n\r\ndata = np.arange(12).reshape(4, 3)\r\n\r\nfor i in range(10):\r\n    kpca = KernelPCA(n_components=2, eigen_solver='arpack')\r\n    print(kpca.fit_transform(data)[0])\r\n```\r\n\r\nOutput:\r\n```\r\n[ -7.79422863e+00   1.96272928e-08]\r\n[ -7.79422863e+00  -8.02208951e-08]\r\n[ -7.79422863e+00   2.05892318e-08]\r\n[  7.79422863e+00   4.33789564e-08]\r\n[  7.79422863e+00  -1.35754077e-08]\r\n[ -7.79422863e+00   1.15692773e-08]\r\n[ -7.79422863e+00  -2.31849470e-08]\r\n[ -7.79422863e+00   2.56004915e-10]\r\n[  7.79422863e+00   2.64278471e-08]\r\n[  7.79422863e+00   4.06180096e-08]\r\n```\nThanks very much!\r\nI will check it later.\n@shuuchen not sure why you closed this but I reopened this. I think this is a valid issue.\n@lesteve OK.\n@lesteve I was taking a look at this issue and it seems to me that not passing `random_state` cannot possibly yield the same result in different calls, given that it'll be based in a random uniformly distributed initial state. Is it really an issue?\nI do not reproduce the issue when fixing the `random_state`:\r\n\r\n```\r\nIn [6]: import numpy as np\r\n   ...: from sklearn.decomposition import KernelPCA\r\n   ...: \r\n   ...: data = np.arange(12).reshape(4, 3)\r\n   ...: \r\n   ...: for i in range(10):\r\n   ...:     kpca = KernelPCA(n_components=2, eigen_solver='arpack', random_state=0)\r\n   ...:     print(kpca.fit_transform(data)[0])\r\n   ...:     \r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n[ -7.79422863e+00   6.27870418e-09]\r\n```\n@shuuchen can you confirm setting the random state solves the problem?\r\n\r\nAlso: did someone in Paris manage to script @lesteve? \n> I do not reproduce the issue when fixing the random_state:\r\n\r\nThis is what I said in https://github.com/scikit-learn/scikit-learn/issues/8798#issuecomment-297959575.\r\n\r\nI still think we should avoid such a big difference using `svd_flip`. PCA does not have this problem because it is using `svd_flip` I think:\r\n\r\n```py\r\nimport numpy as np\r\nfrom sklearn.decomposition import PCA\r\n\r\ndata = np.arange(12).reshape(4, 3)\r\n\r\nfor i in range(10):\r\n    pca = PCA(n_components=2, svd_solver='arpack')\r\n    print(pca.fit_transform(data)[0])\r\n```\r\n\r\nOutput:\r\n```\r\n[-0.          7.79422863]\r\n[-0.          7.79422863]\r\n[ 0.          7.79422863]\r\n[ 0.          7.79422863]\r\n[ 0.          7.79422863]\r\n[-0.          7.79422863]\r\n[ 0.          7.79422863]\r\n[-0.          7.79422863]\r\n[ 0.          7.79422863]\r\n[-0.          7.79422863]\r\n```\r\n\r\n> Also: did someone in Paris manage to script @lesteve?\r\n\r\nI assume you are talking about the relabelling of \"Need Contributor\" to \"help wanted\". I did it the hard way with ghi (command-line interface to github) instead of just renaming the label via the github web interface :-S.\nI can do this to warm myself up for the sprint",
  "created_at": "2019-02-25T11:27:41Z",
  "version": "0.21",
  "FAIL_TO_PASS": "[\"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_deterministic_output\"]",
  "PASS_TO_PASS": "[\"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_invalid_parameters\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_consistent_transform\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_sparse\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_linear_kernel\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_n_components\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_remove_zero_eig\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_precomputed\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_kernel_pca_invalid_kernel\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_gridsearch_pipeline\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_gridsearch_pipeline_precomputed\", \"sklearn/decomposition/tests/test_kernel_pca.py::test_nested_circles\", \"sklearn/decomposition/tests/test_pca.py::test_pca\", \"sklearn/decomposition/tests/test_pca.py::test_pca_arpack_solver\", \"sklearn/decomposition/tests/test_pca.py::test_pca_randomized_solver\", \"sklearn/decomposition/tests/test_pca.py::test_no_empty_slice_warning\", \"sklearn/decomposition/tests/test_pca.py::test_whitening\", \"sklearn/decomposition/tests/test_pca.py::test_explained_variance\", \"sklearn/decomposition/tests/test_pca.py::test_singular_values\", \"sklearn/decomposition/tests/test_pca.py::test_pca_check_projection\", \"sklearn/decomposition/tests/test_pca.py::test_pca_inverse\", \"sklearn/decomposition/tests/test_pca.py::test_pca_validation[full]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_validation[arpack]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_validation[randomized]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_validation[auto]\", \"sklearn/decomposition/tests/test_pca.py::test_n_components_none[full]\", \"sklearn/decomposition/tests/test_pca.py::test_n_components_none[arpack]\", \"sklearn/decomposition/tests/test_pca.py::test_n_components_none[randomized]\", \"sklearn/decomposition/tests/test_pca.py::test_n_components_none[auto]\", \"sklearn/decomposition/tests/test_pca.py::test_randomized_pca_check_projection\", \"sklearn/decomposition/tests/test_pca.py::test_randomized_pca_check_list\", \"sklearn/decomposition/tests/test_pca.py::test_randomized_pca_inverse\", \"sklearn/decomposition/tests/test_pca.py::test_n_components_mle\", \"sklearn/decomposition/tests/test_pca.py::test_pca_dim\", \"sklearn/decomposition/tests/test_pca.py::test_infer_dim_1\", \"sklearn/decomposition/tests/test_pca.py::test_infer_dim_2\", \"sklearn/decomposition/tests/test_pca.py::test_infer_dim_3\", \"sklearn/decomposition/tests/test_pca.py::test_infer_dim_by_explained_variance\", \"sklearn/decomposition/tests/test_pca.py::test_pca_score\", \"sklearn/decomposition/tests/test_pca.py::test_pca_score2\", \"sklearn/decomposition/tests/test_pca.py::test_pca_score3\", \"sklearn/decomposition/tests/test_pca.py::test_pca_score_with_different_solvers\", \"sklearn/decomposition/tests/test_pca.py::test_pca_zero_noise_variance_edge_cases\", \"sklearn/decomposition/tests/test_pca.py::test_svd_solver_auto\", \"sklearn/decomposition/tests/test_pca.py::test_pca_sparse_input[full]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_sparse_input[arpack]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_sparse_input[randomized]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_sparse_input[auto]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_bad_solver\", \"sklearn/decomposition/tests/test_pca.py::test_pca_dtype_preservation[full]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_dtype_preservation[arpack]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_dtype_preservation[randomized]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_dtype_preservation[auto]\", \"sklearn/decomposition/tests/test_pca.py::test_pca_deterministic_output\"]",
  "environment_setup_commit": "7813f7efb5b2012412888b69e73d76f2df2b50b6",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:30.991097",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}