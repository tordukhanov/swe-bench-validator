{
  "repo": "sphinx-doc/sphinx",
  "instance_id": "sphinx-doc__sphinx-10504",
  "base_commit": "113e1d8759e444342544bd97ed93bc1622b9a6bb",
  "patch": "diff --git a/sphinx/builders/html/transforms.py b/sphinx/builders/html/transforms.py\n--- a/sphinx/builders/html/transforms.py\n+++ b/sphinx/builders/html/transforms.py\n@@ -40,7 +40,9 @@ class KeyboardTransform(SphinxPostTransform):\n \n     def run(self, **kwargs: Any) -> None:\n         matcher = NodeMatcher(nodes.literal, classes=[\"kbd\"])\n-        for node in self.document.findall(matcher):  # type: nodes.literal\n+        # this list must be pre-created as during iteration new nodes\n+        # are added which match the condition in the NodeMatcher.\n+        for node in list(self.document.findall(matcher)):  # type: nodes.literal\n             parts = self.pattern.split(node[-1].astext())\n             if len(parts) == 1 or self.is_multiwords_key(parts):\n                 continue\n",
  "test_patch": "diff --git a/tests/roots/test-transforms-post_transforms-keyboard/conf.py b/tests/roots/test-transforms-post_transforms-keyboard/conf.py\nnew file mode 100644\ndiff --git a/tests/roots/test-transforms-post_transforms-keyboard/index.rst b/tests/roots/test-transforms-post_transforms-keyboard/index.rst\nnew file mode 100644\n--- /dev/null\n+++ b/tests/roots/test-transforms-post_transforms-keyboard/index.rst\n@@ -0,0 +1,4 @@\n+Regression test for issue 10495\n+===============================\n+\n+:kbd:`spanish - inquisition`\ndiff --git a/tests/test_transforms_post_transforms.py b/tests/test_transforms_post_transforms.py\n--- a/tests/test_transforms_post_transforms.py\n+++ b/tests/test_transforms_post_transforms.py\n@@ -48,3 +48,12 @@ def missing_reference(app, env, node, contnode):\n \n     content = (app.outdir / 'index.html').read_text(encoding='utf8')\n     assert '<span class=\"n\"><span class=\"pre\">Age</span></span>' in content\n+\n+\n+@pytest.mark.sphinx('html', testroot='transforms-post_transforms-keyboard',\n+                    freshenv=True)\n+def test_keyboard_hyphen_spaces(app):\n+    \"\"\"Regression test for issue 10495, we want no crash.\"\"\"\n+    app.build()\n+    assert \"spanish\" in (app.outdir / 'index.html').read_text(encoding='utf8')\n+    assert \"inquisition\" in (app.outdir / 'index.html').read_text(encoding='utf8')\n",
  "problem_statement": "IndexError: list index out of range\n### Describe the bug\n\nmake[1]: *** [Documentation/Makefile:96: htmldocs] Error 2\r\nmake: *** [Makefile:1678: htmldocs] Error 2\r\n==> ERROR: A failure occurred in build().\r\n    Aborting...\r\n\n\n### How to Reproduce\n\n[Arch Build System](https://wiki.archlinux.org/title/Arch_Build_System)\r\n```\r\n$ cd linux\r\n$ asp checkout linux\r\n$ asp update && git pull\r\n$ cd repos/core-x86_64/\r\n$ makepkg --noconfirm -cCsfir\r\n```\r\n\n\n### Expected behavior\n\n1. `linux-5.18.arch1-1-x86_64.pkg.tar.zst`\r\n2. `linux-docs-5.18.arch1-1-x86_64.pkg.tar.zst`\r\n3. `linux-headers-5.18.arch1-1-x86_64.pkg.tar.zst`\r\n\n\n### Your project\n\narchlinux\n\n### Screenshots\n\n```\r\ntail -n 50 /tmp/sphinx-err-irzy92f8.log\r\n```\r\n----\r\n```\r\n#   writing output... [  5%] admin-guide/device-mapper/dm-integrity .. admin-guide/gpio/gpio-aggregator\r\n#   writing output... [  6%] admin-guide/gpio/gpio-mockup .. admin-guide/laptops/lg-laptop\r\n#   writing output... [  7%] admin-guide/laptops/sony-laptop .. admin-guide/media/dvb-usb-af9035-cardlist\r\n#   writing output... [  8%] admin-guide/media/dvb-usb-anysee-cardlist .. admin-guide/media/dvb-usb-zd1301-cardlist\r\n# Loaded extensions:\r\n#   sphinx.ext.mathjax (5.0.0) from /usr/lib/python3.10/site-packages/sphinx/ext/mathjax.py\r\n#   sphinxcontrib.applehelp (1.0.2) from /usr/lib/python3.10/site-packages/sphinxcontrib/applehelp/__init__.py\r\n#   sphinxcontrib.devhelp (1.0.2) from /usr/lib/python3.10/site-packages/sphinxcontrib/devhelp/__init__.py\r\n#   sphinxcontrib.htmlhelp (2.0.0) from /usr/lib/python3.10/site-packages/sphinxcontrib/htmlhelp/__init__.py\r\n#   sphinxcontrib.serializinghtml (1.1.5) from /usr/lib/python3.10/site-packages/sphinxcontrib/serializinghtml/__init__.py\r\n#   sphinxcontrib.qthelp (1.0.3) from /usr/lib/python3.10/site-packages/sphinxcontrib/qthelp/__init__.py\r\n#   alabaster (0.7.12) from /usr/lib/python3.10/site-packages/alabaster/__init__.py\r\n#   kerneldoc (1.0) from~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/kerneldoc.py\r\n#   rstFlatTable (1.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/rstFlatTable.py\r\n#   kernel_include (1.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/kernel_include.py\r\n#   kfigure (1.0.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/kfigure.py\r\n#   sphinx.ext.ifconfig (5.0.0) from /usr/lib/python3.10/site-packages/sphinx/ext/ifconfig.py\r\n#   automarkup (unknown version) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/automarkup.py\r\n#   maintainers_include (1.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/maintainers_include.py\r\n#   kernel_abi (1.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/kernel_abi.py\r\n#   kernel_feat (1.0) from ~/pkg/PKGBUILD/linux/repos/core-x86_64/src/archlinux-linux/Documentation/sphinx/kernel_feat.py\r\n#   sphinx.ext.imgmath (5.0.0) from /usr/lib/python3.10/site-packages/sphinx/ext/imgmath.py\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/cmd/build.py\", line 276, in build_main\r\n    app.build(args.force_all, filenames)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/application.py\", line 329, in build\r\n    self.builder.build_update()\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/builders/__init__.py\", line 288, in build_update\r\n    self.build(to_build,\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/builders/__init__.py\", line 352, in build\r\n    self.write(docnames, list(updated_docnames), method)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/builders/__init__.py\", line 541, in write\r\n    self._write_parallel(sorted(docnames),\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/builders/__init__.py\", line 585, in _write_parallel\r\n    doctree = self.env.get_and_resolve_doctree(docname, self)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/environment/__init__.py\", line 530, in get_and_resolve_doctree\r\n    self.apply_post_transforms(doctree, docname)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/environment/__init__.py\", line 576, in apply_post_transforms\r\n    transformer.apply_transforms()\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/transforms/__init__.py\", line 80, in apply_transforms\r\n    super().apply_transforms()\r\n  File \"/usr/lib/python3.10/site-packages/docutils/transforms/__init__.py\", line 171, in apply_transforms\r\n    transform.apply(**kwargs)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/transforms/post_transforms/__init__.py\", line 35, in apply\r\n    self.run(**kwargs)\r\n  File \"/usr/lib/python3.10/site-packages/sphinx/builders/html/transforms.py\", line 44, in run\r\n    parts = self.pattern.split(node[-1].astext())\r\n  File \"/usr/lib/python3.10/site-packages/docutils/nodes.py\", line 654, in __getitem__\r\n    return self.children[key]\r\nIndexError: list index out of range\r\n```\r\n\n\n### OS\n\nLinux RYZEN 5.18.0-arch1-1 x86_64\n\n### Python version\n\n`Python 3.10.4`\n\n### Sphinx version\n\n`sphinx-build 5.0.0`\n\n### Sphinx extensions\n\n`sphinx-autogen 5.0.0` , `sphinx-apidoc 5.0.0` , `sphinx-quickstart 5.0.0`\n\n### Extra tools\n\n`gcc (GCC) 12.1.0` , `GNU Make 4.3` , `ldd (GNU libc) 2.35`, `git version 2.36.1`, `GNU bash, version 5.1.16(1)`\n\n### Additional context\n\n_No response_\n",
  "hints_text": "Getting the same in a Github Action, started happening yesterday, as the build switched to Sphinx 5:\r\n\r\n```\r\nsphinx:\r\n     [echo] Running sphinx-build -D release=28-SNAPSHOT -q -W --keep-going -j auto -b html -d \"/home/runner/work/geotools/geotools/docs/target/developer/doctrees\" . \"/home/runner/work/geotools/geotools/docs/target/developer/html\"\r\n     [exec] \r\n     [exec] Exception occurred:\r\n     [exec]   File \"/opt/hostedtoolcache/Python/3.10.4/x64/lib/python3.10/site-packages/docutils/nodes.py\", line 654, in __getitem__\r\n     [exec]     return self.children[key]\r\n     [exec] IndexError: list index out of range\r\n     [exec] The full traceback has been saved in /tmp/sphinx-err-f7bvx8hf.log, if you want to report the issue to the developers.\r\n     [exec] Please also report this if it was a user error, so that a better error message can be provided next time.\r\n     [exec] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!\r\n```\nHi @cyring  / @aaime -- is your project the Linux kernel? I can't really reproduce this on Windows.\r\n\r\nCan you try deleting as much of the docs as possible before it stops failing for a minimal reproducer? It's likely we'll do a [`5.0.1` release](https://github.com/sphinx-doc/sphinx/milestone/127) as there are a few other bugs.\r\n\r\nA\n@AA-Turner in my case it's the [GeoTools documentation](https://github.com/geotools/geotools/tree/main/docs).\r\nUnfortunately, I cannot reproduce it on my local machine, it only happens on the Github actions... I've tried for a while but don't know enough about python and its dependency management (or at least, that's why I think I'm not able to reproduce).\r\n\r\nBut oh... this is the output during the pip-action bit that sets up Sphinx, maybe you can figure out something from this?\r\n\r\n```\r\n/opt/hostedtoolcache/Python/3.10.4/x64/python -m pip install sphinx requests\r\nCollecting sphinx\r\n  Downloading Sphinx-5.0.0-py3-none-any.whl (3.1 MB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 3.1/3.1 MB 76.5 MB/s eta 0:00:00\r\nCollecting requests\r\n  Downloading requests-2.27.1-py2.py3-none-any.whl (63 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 63.1/63.1 kB 17.5 MB/s eta 0:00:00\r\nCollecting sphinxcontrib-devhelp\r\n  Downloading sphinxcontrib_devhelp-1.0.2-py2.py3-none-any.whl (84 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 84.7/84.7 kB 21.7 MB/s eta 0:00:00\r\nCollecting sphinxcontrib-jsmath\r\n  Downloading sphinxcontrib_jsmath-1.0.1-py2.py3-none-any.whl (5.1 kB)\r\nCollecting docutils<0.19,>=0.[14](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:15)\r\n  Downloading docutils-0.18.1-py2.py3-none-any.whl (570 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 570.0/570.0 kB 67.7 MB/s eta 0:00:00\r\nCollecting sphinxcontrib-serializinghtml>=1.1.5\r\n  Downloading sphinxcontrib_serializinghtml-1.1.5-py2.py3-none-any.whl (94 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 94.0/94.0 kB 27.4 MB/s eta 0:00:00\r\nCollecting snowballstemmer>=1.1\r\n  Downloading snowballstemmer-2.2.0-py2.py3-none-any.whl (93 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 93.0/93.0 kB 26.7 MB/s eta 0:00:00\r\nCollecting sphinxcontrib-htmlhelp>=2.0.0\r\n  Downloading sphinxcontrib_htmlhelp-2.0.0-py2.py3-none-any.whl (100 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.5/100.5 kB 30.2 MB/s eta 0:00:00\r\nCollecting packaging\r\n  Downloading packaging-21.3-py3-none-any.whl (40 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 40.8/40.8 kB 12.6 MB/s eta 0:00:00\r\nCollecting imagesize\r\n  Downloading imagesize-1.3.0-py2.py3-none-any.whl (5.2 kB)\r\nCollecting Pygments>=2.0\r\n  Downloading Pygments-2.12.0-py3-none-any.whl (1.1 MB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.1/1.1 MB 80.5 MB/s eta 0:00:00\r\nCollecting babel>=1.3\r\n  Downloading Babel-2.10.1-py3-none-any.whl (9.5 MB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 9.5/9.5 MB 95.4 MB/s eta 0:00:00\r\nCollecting Jinja2>=2.3\r\n  Downloading Jinja2-3.1.2-py3-none-any.whl (133 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 133.1/133.1 kB 36.5 MB/s eta 0:00:00\r\nCollecting alabaster<0.8,>=0.7\r\n  Downloading alabaster-0.7.12-py2.py3-none-any.whl (14 kB)\r\nCollecting sphinxcontrib-applehelp\r\n  Downloading sphinxcontrib_applehelp-1.0.2-py2.py3-none-any.whl (121 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 121.2/121.2 kB 38.8 MB/s eta 0:00:00\r\nCollecting sphinxcontrib-qthelp\r\n  Downloading sphinxcontrib_qthelp-1.0.3-py2.py3-none-any.whl (90 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 90.6/90.6 kB 21.1 MB/s eta 0:00:00\r\nCollecting idna<4,>=2.5\r\n  Downloading idna-3.3-py3-none-any.whl (61 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 61.2/61.2 kB 18.6 MB/s eta 0:00:00\r\nCollecting certifi>=2017.4.17\r\n  Downloading certifi-2022.5.18.1-py3-none-any.whl ([15](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:16)5 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 155.2/155.2 kB 39.2 MB/s eta 0:00:00\r\nCollecting urllib3<1.27,>=1.21.1\r\n  Downloading urllib3-1.26.9-py2.py3-none-any.whl (138 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 139.0/139.0 kB 33.4 MB/s eta 0:00:00\r\nCollecting charset-normalizer~=2.0.0\r\n  Downloading charset_normalizer-2.0.12-py3-none-any.whl (39 kB)\r\nCollecting pytz>=2015.7\r\n  Downloading pytz-2022.1-py2.py3-none-any.whl (503 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 503.5/503.5 kB 69.4 MB/s eta 0:00:00\r\nCollecting MarkupSafe>=2.0\r\n  Downloading MarkupSafe-2.1.1-cp310-cp310-manylinux_2_[17](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:18)_x86_64.manylinux2014_x86_64.whl (25 kB)\r\nCollecting pyparsing!=3.0.5,>=2.0.2\r\n  Downloading pyparsing-3.0.9-py3-none-any.whl (98 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 98.3/98.3 kB 28.0 MB/s eta 0:00:00\r\nInstalling collected packages: snowballstemmer, pytz, alabaster, urllib3, sphinxcontrib-serializinghtml, sphinxcontrib-qthelp, sphinxcontrib-jsmath, sphinxcontrib-htmlhelp, sphinxcontrib-devhelp, sphinxcontrib-applehelp, pyparsing, Pygments, MarkupSafe, imagesize, idna, docutils, charset-normalizer, certifi, babel, requests, packaging, Jinja2, sphinx\r\nSuccessfully installed Jinja2-3.1.2 MarkupSafe-2.1.1 Pygments-2.12.0 alabaster-0.7.12 babel-2.10.1 certifi-2022.5.[18](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:19).1 charset-normalizer-2.0.12 docutils-0.18.1 idna-3.3 imagesize-1.3.0 packaging-21.3 pyparsing-3.0.9 pytz-[20](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:21)[22](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:23).1 requests-2.27.1 snowballstemmer-2.2.0 sphinx-5.0.0 sphinxcontrib-applehelp-1.0.2 sphinxcontrib-devhelp-1.0.2 sphinxcontrib-htmlhelp-2.0.0 sphinxcontrib-jsmath-1.0.1 sphinxcontrib-qthelp-1.0.3 sphinxcontrib-serializinghtml-1.1.5 urllib3-1.[26](https://github.com/geotools/geotools/runs/6651466756?check_suite_focus=true#step:7:27).9\r\n```\n> Hi @cyring / @aaime -- is your project the Linux kernel? I can't really reproduce this on Windows.\r\n> \r\n> Can you try deleting as much of the docs as possible before it stops failing for a minimal reproducer? It's likely we'll do a [`5.0.1` release](https://github.com/sphinx-doc/sphinx/milestone/127) as there are a few other bugs.\r\n> \r\n> A\r\n\r\nHello,\r\n\r\nThe purpose is to build the latest mainstream Linux kernel. \r\nThe working operating system is Linux from the Arch Linux distribution which provides some scripts, named ASP, to build and install the next kernel release: a rolling release.\r\nAmong those scripts, is run the kernel html doc which is Sphinx based. That part is failing.\r\n\r\nFyi, I have been doing such kernel build once a week for months/years and this is the first time such issue is encountered.\r\nBe also aware, as rolling release, Arch brings the latest stable software packages and thus Sphinx dependencies, like Python.\r\n\r\nHope it helps, feel free to ask other details.\n@cyring Sphinx should save a full log on failure, please could you upload it here?\r\n\r\nA\nI found a minimal reproducer from @aaime's GeoTools documentation (after working out how to read an XML build script!!):\r\n\r\n```python\r\nimport shutil\r\nfrom pathlib import Path\r\n\r\nfrom sphinx.cmd.make_mode import run_make_mode\r\n\r\n\r\ndef write(filename, text): Path(filename).write_text(text, encoding=\"utf-8\")\r\n\r\nwrite(\"conf.py\", '''\\\r\n''')\r\n\r\nwrite(\"index.rst\", '''\\\r\n:kbd:`blah - blah`\r\n''')\r\n\r\nshutil.rmtree(\"_build\", ignore_errors=True)\r\nrun_make_mode([\"html\", \".\", \"_build\", \"-T\", \"-W\"])\r\n```\r\n\r\nrun as `reproducer_10495.py`. The `blah - blah` is important -- there must be a hypen and at least one space. @cyring can you check if a similar construct appears in the Linux docs? (`` :kbd:`[a-z0-9 ]*?( \\-| \\-| \\- )[a-z0-9 ]*?` ``)\r\n\r\nA",
  "created_at": "2022-05-31T23:37:32Z",
  "version": "5.0",
  "FAIL_TO_PASS": "[\"tests/test_transforms_post_transforms.py::test_keyboard_hyphen_spaces\"]",
  "PASS_TO_PASS": "[\"tests/test_transforms_post_transforms.py::test_nitpicky_warning\", \"tests/test_transforms_post_transforms.py::test_missing_reference\", \"tests/test_transforms_post_transforms.py::test_missing_reference_conditional_pending_xref\"]",
  "environment_setup_commit": "60775ec4c4ea08509eee4b564cbf90f316021aff",
  "_download_metadata": {
    "downloaded_at": "2025-10-07T21:23:31.034570",
    "dataset_name": "swe-bench",
    "split": "test",
    "downloader_version": "0.1.0"
  }
}